<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>FMD: calcenergymultiprojsel.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<h1>calcenergymultiprojsel.c File Reference</h1>  </div>
</div>
<div class="contents">
<code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;unistd.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;complex.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="SlaterDet_8h_source.html">fmd/SlaterDet.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="Ovlap_8h_source.html">fmd/Ovlap.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="Observables_8h_source.html">fmd/Observables.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="Projection_8h_source.html">fmd/Projection.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="Symmetry_8h_source.html">fmd/Symmetry.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="ProjectedObservables_8h_source.html">fmd/ProjectedObservables.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">misc/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="physics_8h_source.html">misc/physics.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cmat_8h_source.html">numerics/cmat.h</a>&quot;</code><br/>

<p><a href="calcenergymultiprojsel_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="calcenergymultiprojsel_8c.html#a7c53005f48be691eb85407c5a9588267">MAXSTATES</a>&nbsp;&nbsp;&nbsp;500</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="calcenergymultiprojsel_8c.html#ac47275dec82395b311244df2f1af2389">EUNDEFINED</a>&nbsp;&nbsp;&nbsp;1000.0</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="calcenergymultiprojsel_8c.html#a1ee8c1526a6c435703213460fa61ae2b">SQR</a> (int i)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="calcenergymultiprojsel_8c.html#a04dbed99447ff9ce88230b596b204173">energy</a> (const <a class="el" href="structProjection.html">Projection</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#a937218b25a684555a6d94a5058c7b358">P</a>, const <a class="el" href="structEigenstates.html">Eigenstates</a> *E, int <a class="el" href="MinimizerDONLP2vappiso_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>, int p, int i)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="calcenergymultiprojsel_8c.html#a9e8701775617dc23c556aec80298eb44">calcbasisovlap</a> (const <a class="el" href="structProjection.html">Projection</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#a937218b25a684555a6d94a5058c7b358">P</a>, const <a class="el" href="structEigenstates.html">Eigenstates</a> *E, const complex double ***ovlmes, int <a class="el" href="donlp2_8h.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, int <a class="el" href="MinimizerDONLP2vappiso_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>, int p)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="calcenergymultiprojsel_8c.html#ab452b700e25a21cee07421320c343874">calcenergyeigenvalue</a> (const <a class="el" href="structProjection.html">Projection</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#a937218b25a684555a6d94a5058c7b358">P</a>, const <a class="el" href="structEigenstates.html">Eigenstates</a> *E, const <a class="el" href="structObservablesod.html">Observablesod</a> ***obsme, int <a class="el" href="donlp2_8h.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, int <a class="el" href="MinimizerDONLP2vappiso_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>, int p, int ei, double thresh, double minnorm)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="calcenergymultiprojsel_8c.html#a439e0eb195e5140de02cfb5b3cbcb79b">readorcalcandwriteprojectedMBMEfromtoFile</a> (const char *mbfile, const char *mbfilep, const <a class="el" href="structProjection.html">Projection</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#a937218b25a684555a6d94a5058c7b358">P</a>, const <a class="el" href="structManyBodyOperator.html">ManyBodyOperator</a> *Op, const <a class="el" href="structSlaterDet.html">SlaterDet</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#ac4f7151b4c1c951d242ff9f8856381a0">Q</a>, const <a class="el" href="structSlaterDet.html">SlaterDet</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#a302070733a377867b458d28f3146454f">Qp</a>, <a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> S, <a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> Sp, const void **mbme)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="calcenergymultiprojsel_8c.html#aa1a34cfe1cc65e30c9f60768f7df9a5d">cleanup</a> (int ret)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="calcenergymultiprojsel_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a> (int argc, char *argv[])</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>iteratively select subset of many-body states that give the lowest energy</p>
<p>we might work in a large set of states selecting only a small number of them memory consumption becomes a problem,</p>
<p>(c) 2006 Thomas Neff </p>

<p>Definition in file <a class="el" href="calcenergymultiprojsel_8c_source.html">calcenergymultiprojsel.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="ac47275dec82395b311244df2f1af2389"></a><!-- doxytag: member="calcenergymultiprojsel.c::EUNDEFINED" ref="ac47275dec82395b311244df2f1af2389" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define EUNDEFINED&nbsp;&nbsp;&nbsp;1000.0</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="calcenergymultiprojsel_8c_source.html#l00043">43</a> of file <a class="el" href="calcenergymultiprojsel_8c_source.html">calcenergymultiprojsel.c</a>.</p>

</div>
</div>
<a class="anchor" id="a7c53005f48be691eb85407c5a9588267"></a><!-- doxytag: member="calcenergymultiprojsel.c::MAXSTATES" ref="a7c53005f48be691eb85407c5a9588267" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAXSTATES&nbsp;&nbsp;&nbsp;500</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="calcenergymultiprojsel_8c_source.html#l00041">41</a> of file <a class="el" href="calcenergymultiprojsel_8c_source.html">calcenergymultiprojsel.c</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a9e8701775617dc23c556aec80298eb44"></a><!-- doxytag: member="calcenergymultiprojsel.c::calcbasisovlap" ref="a9e8701775617dc23c556aec80298eb44" args="(const Projection *P, const Eigenstates *E, const complex double ***ovlmes, int n, int j, int p)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double calcbasisovlap </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structProjection.html">Projection</a> *&nbsp;</td>
          <td class="paramname"> <em>P</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structEigenstates.html">Eigenstates</a> *&nbsp;</td>
          <td class="paramname"> <em>E</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const complex double ***&nbsp;</td>
          <td class="paramname"> <em>ovlmes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>p</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="calcenergymultiprojsel_8c_source.html#l00068">68</a> of file <a class="el" href="calcenergymultiprojsel_8c_source.html">calcenergymultiprojsel.c</a>.</p>

<p>References <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00122">dim</a>, <a class="el" href="Projection_8h_source.html#l00147">Eigenstates::index</a>, <a class="el" href="Projection_8h_source.html#l00093">Projection::jmax</a>, <a class="el" href="MinimizerDONLP2orthogonalproj_8c_source.html#l00098">k</a>, <a class="el" href="Projection_8h_source.html#l00146">Eigenstates::ngood</a>, <a class="el" href="Projection_8h_source.html#l00148">Eigenstates::norm</a>, <a class="el" href="cmat_8c_source.html#l00208">pseudoinverse()</a>, <a class="el" href="calcbasisovlapmulti_8c_source.html#l00032">SQR</a>, <a class="el" href="Projection_8h_source.html#l00144">Eigenstates::V</a>, and <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00121">V</a>.</p>

<p>Referenced by <a class="el" href="calcenergymultiprojsel_8c_source.html#l00335">main()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> ipj = idxpij(P-&gt;<a class="code" href="structProjection.html#aaab8cf237ff5e23d0f7abb05117387fe" title="calculate up to (jmax-1)/2">jmax</a>,p,<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>);
 
  complex <span class="keywordtype">double</span>* nbb = malloc(<a class="code" href="calcbasisovlapmulti_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">SQR</a>((<a class="code" href="HOBasis_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>-1)*(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1))*<span class="keyword">sizeof</span>(complex <span class="keywordtype">double</span>)); 
  complex <span class="keywordtype">double</span>* obb = malloc(<a class="code" href="calcbasisovlapmulti_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">SQR</a>((<a class="code" href="HOBasis_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>-1)*(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1))*<span class="keyword">sizeof</span>(complex <span class="keywordtype">double</span>));

  <span class="keywordtype">int</span> a,b,ia,idxa,iai,ib,idxb,ibi,ka,kb,<a class="code" href="MinimizerDONLP2multivapp_8c.html#ad5bd801f521717ed9f092360c3ba3b5e">dim</a>;

  dim=0;
  <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="HOBasis_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>-1; a++)
    dim += E[a].ngood[ipj];

  <span class="keywordflow">for</span> (idxb=0; idxb&lt;dim; idxb++)
    <span class="keywordflow">for</span> (idxa=0; idxa&lt;dim; idxa++)
      nbb[idxa+idxb*dim] = 0.0;
      
  <span class="comment">// n-1 overlap matrix</span>

  idxb=-1;
  <span class="keywordflow">for</span> (b=0; b&lt;n-1; b++)
    <span class="keywordflow">for</span> (ib=0; ib&lt;E[b].<a class="code" href="structEigenstates.html#a44b4a004824004e5635d83048d875e21" title="number of eigenstates considered as &amp;quot;good&amp;quot;">ngood</a>[ipj]; ib++) {
      ibi = E[b].<a class="code" href="structEigenstates.html#a0a44e079b2e594d09a15d3a1ddd4a35c" title="indexing eigenstates according to &amp;quot;goodness&amp;quot;">index</a>[ipj][ib];
      idxb++;
      idxa=-1;
      <span class="keywordflow">for</span> (a=0; a&lt;n-1; a++)
        <span class="keywordflow">for</span> (ia=0; ia&lt;E[a].<a class="code" href="structEigenstates.html#a44b4a004824004e5635d83048d875e21" title="number of eigenstates considered as &amp;quot;good&amp;quot;">ngood</a>[ipj]; ia++) {
          iai = E[a].<a class="code" href="structEigenstates.html#a0a44e079b2e594d09a15d3a1ddd4a35c" title="indexing eigenstates according to &amp;quot;goodness&amp;quot;">index</a>[ipj][ia];
          idxa++;
          <span class="keywordflow">for</span> (kb=0; kb&lt;<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1; kb++)
            <span class="keywordflow">for</span> (ka=0; ka&lt;j+1; ka++)
              nbb[idxa+idxb*dim] += 
                conj(E[a].<a class="code" href="MinimizerDONLP2multivapp_8c.html#ada7b84dafb505b22eca2753ef852e94a">V</a>[ipj][ka+iai*(j+1)])*
                ovlmes[a+b*n][ipj][ka+kb*(j+1)]*
                E[b].<a class="code" href="MinimizerDONLP2multivapp_8c.html#ada7b84dafb505b22eca2753ef852e94a">V</a>[ipj][kb+ibi*(j+1)];
        }
    }

  <span class="comment">// one operator</span>

  <span class="keywordtype">double</span> thresh=1e-9;
  <a class="code" href="cmat_8c.html#ab72dbed4da7403b5c000b0b8b8c10cbf" title="calculate pseudoinverse B of A using SVD">pseudoinverse</a>(nbb, obb, dim, thresh);

  <span class="comment">// calculate one operator matrix element</span>
          
  <span class="keywordtype">int</span> i,ii,<a class="code" href="MinimizerDONLP2orthogonalproj_8c.html#ab66ed8e0098c0a86b458672a55a9cca9">k</a>,kp;
  <span class="keywordtype">double</span> ovlmax = 0.0, ovl;

  <span class="comment">// return biggest overlap</span>
  <span class="keywordflow">for</span> (i=0; i&lt;E[n-1].<a class="code" href="structEigenstates.html#a44b4a004824004e5635d83048d875e21" title="number of eigenstates considered as &amp;quot;good&amp;quot;">ngood</a>[ipj]; i++) {

    ovl = 0.0;

    ii = E[n-1].<a class="code" href="structEigenstates.html#a0a44e079b2e594d09a15d3a1ddd4a35c" title="indexing eigenstates according to &amp;quot;goodness&amp;quot;">index</a>[ipj][i];
    idxb=-1;
    <span class="keywordflow">for</span> (b=0; b&lt;n-1; b++)
      <span class="keywordflow">for</span> (ib=0; ib&lt;E[b].<a class="code" href="structEigenstates.html#a44b4a004824004e5635d83048d875e21" title="number of eigenstates considered as &amp;quot;good&amp;quot;">ngood</a>[ipj]; ib++) {
        ibi = E[b].<a class="code" href="structEigenstates.html#a0a44e079b2e594d09a15d3a1ddd4a35c" title="indexing eigenstates according to &amp;quot;goodness&amp;quot;">index</a>[ipj][ib];
        idxb++;
        idxa=-1;
        <span class="keywordflow">for</span> (a=0; a&lt;n-1; a++)
          <span class="keywordflow">for</span> (ia=0; ia&lt;E[a].<a class="code" href="structEigenstates.html#a44b4a004824004e5635d83048d875e21" title="number of eigenstates considered as &amp;quot;good&amp;quot;">ngood</a>[ipj]; ia++) {
            iai = E[a].<a class="code" href="structEigenstates.html#a0a44e079b2e594d09a15d3a1ddd4a35c" title="indexing eigenstates according to &amp;quot;goodness&amp;quot;">index</a>[ipj][ia];
            idxa++;

            <span class="keywordflow">for</span> (kb=0; kb&lt;j+1; kb++)
              <span class="keywordflow">for</span> (ka=0; ka&lt;j+1; ka++)
                <span class="keywordflow">for</span> (kp=0; kp&lt;j+1; kp++)
                  <span class="keywordflow">for</span> (k=0; k&lt;j+1; k++)
                    
                    ovl += conj(E[n-1].<a class="code" href="MinimizerDONLP2multivapp_8c.html#ada7b84dafb505b22eca2753ef852e94a">V</a>[ipj][k+ii*(j+1)])*
                      ovlmes[(n-1)+a*n][ipj][k+ka*(j+1)]*
                      E[a].<a class="code" href="structEigenstates.html#a6e03cbd0f964bc8d73161266831cc874" title="eigenvectors">V</a>[ipj][ka+iai*(j+1)]*
                      obb[idxa+idxb*dim]*
                      conj(E[b].<a class="code" href="MinimizerDONLP2multivapp_8c.html#ada7b84dafb505b22eca2753ef852e94a">V</a>[ipj][kb+ibi*(j+1)])*
                      ovlmes[b+(n-1)*n][ipj][kb+kp*(j+1)]*
                      E[n-1].<a class="code" href="MinimizerDONLP2multivapp_8c.html#ada7b84dafb505b22eca2753ef852e94a">V</a>[ipj][kp+ii*(j+1)]/
                      E[n-1].<a class="code" href="structEigenstates.html#aafb83e8289ec1cb2c7e882311c35ea3a" title="many-body norm^2 of eigenstates">norm</a>[ipj][ii];

          }
      }

    <span class="keywordflow">if</span> (ovl &gt; ovlmax)
      ovlmax = ovl;
  }
                         
  free(nbb);
  free(obb);

  <span class="keywordflow">return</span> ovlmax;
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab452b700e25a21cee07421320c343874"></a><!-- doxytag: member="calcenergymultiprojsel.c::calcenergyeigenvalue" ref="ab452b700e25a21cee07421320c343874" args="(const Projection *P, const Eigenstates *E, const Observablesod ***obsme, int n, int j, int p, int ei, double thresh, double minnorm)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double calcenergyeigenvalue </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structProjection.html">Projection</a> *&nbsp;</td>
          <td class="paramname"> <em>P</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structEigenstates.html">Eigenstates</a> *&nbsp;</td>
          <td class="paramname"> <em>E</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structObservablesod.html">Observablesod</a> ***&nbsp;</td>
          <td class="paramname"> <em>obsme</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ei</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>thresh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&nbsp;</td>
          <td class="paramname"> <em>minnorm</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="calcenergymultiprojsel_8c_source.html#l00171">171</a> of file <a class="el" href="calcenergymultiprojsel_8c_source.html">calcenergymultiprojsel.c</a>.</p>

<p>References <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00122">dim</a>, <a class="el" href="cmat_8c_source.html#l00264">generalizedeigensystem()</a>, <a class="el" href="Observables_8h_source.html#l00040">Observablesod::h</a>, <a class="el" href="md5_8c.html#ae42219072d798876e6b08e6b78614ff6">H</a>, <a class="el" href="Projection_8h_source.html#l00147">Eigenstates::index</a>, <a class="el" href="Projection_8h_source.html#l00093">Projection::jmax</a>, <a class="el" href="MinimizerDONLP2orthogonalproj_8c_source.html#l00098">k</a>, <a class="el" href="HOBasis_8c_source.html#l00050">l</a>, <a class="el" href="HOBasis_8c_source.html#l00051">m</a>, <a class="el" href="Observables_8h_source.html#l00039">Observablesod::n</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00124">N</a>, <a class="el" href="Projection_8h_source.html#l00146">Eigenstates::ngood</a>, <a class="el" href="Projection_8h_source.html#l00148">Eigenstates::norm</a>, <a class="el" href="calcbasisovlapmulti_8c_source.html#l00032">SQR</a>, <a class="el" href="Projection_8h_source.html#l00144">Eigenstates::V</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00121">V</a>, and <a class="el" href="donlp2_8h_source.html#l00057">val</a>.</p>

<p>Referenced by <a class="el" href="calcenergymultiprojsel_8c_source.html#l00335">main()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> ipj=idxpij(P-&gt;<a class="code" href="structProjection.html#aaab8cf237ff5e23d0f7abb05117387fe" title="calculate up to (jmax-1)/2">jmax</a>,p,<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>);
  <span class="keywordtype">int</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#ad5bd801f521717ed9f092360c3ba3b5e">dim</a>, i;
  <span class="keywordtype">double</span> norma2, normb2;

  dim=0;
  <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="HOBasis_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>; i++)
    dim += E[i].ngood[ipj];

  <span class="comment">// do we have at least a one-dimensional space</span>
  <span class="keywordflow">if</span> (dim == 0) {
    <span class="keywordflow">return</span> EUNDEFINED;
  } <span class="keywordflow">else</span> {

    complex <span class="keywordtype">double</span> *<a class="code" href="md5_8c.html#ae42219072d798876e6b08e6b78614ff6">H</a> = malloc(<a class="code" href="calcbasisovlapmulti_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">SQR</a>(n*(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1))*<span class="keyword">sizeof</span>(complex <span class="keywordtype">double</span>));
    complex <span class="keywordtype">double</span> *<a class="code" href="MinimizerDONLP2multivapp_8c.html#afa106e3c58721409e0e2c7ae6980cf25">N</a> = malloc(<a class="code" href="calcbasisovlapmulti_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">SQR</a>(n*(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1))*<span class="keyword">sizeof</span>(complex <span class="keywordtype">double</span>));
    complex <span class="keywordtype">double</span> *v = malloc(n*(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1)*<span class="keyword">sizeof</span>(complex <span class="keywordtype">double</span>));
    complex <span class="keywordtype">double</span> *<a class="code" href="MinimizerDONLP2multivapp_8c.html#ada7b84dafb505b22eca2753ef852e94a">V</a> = malloc(<a class="code" href="calcbasisovlapmulti_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">SQR</a>(n*(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1))*<span class="keyword">sizeof</span>(complex <span class="keywordtype">double</span>));
  
    <span class="keywordtype">int</span> a, b;
    <span class="keywordtype">int</span> <a class="code" href="HOBasis_8c.html#a742204794ea328ba293fe59cec79b990">m</a>, <a class="code" href="MinimizerDONLP2orthogonalproj_8c.html#ab66ed8e0098c0a86b458672a55a9cca9">k</a>, <a class="code" href="HOBasis_8c.html#a89606eca6b563ec68d2da2e84657736f">l</a>;
    <span class="keywordtype">int</span> d;
    <span class="keywordtype">int</span> ai, bi, iai, ibi, idxa, idxb;
 
    idxb=-1;
    <span class="keywordflow">for</span> (b=0; b&lt;n; b++)
      <span class="keywordflow">for</span> (bi=0; bi&lt;E[b].<a class="code" href="structEigenstates.html#a44b4a004824004e5635d83048d875e21" title="number of eigenstates considered as &amp;quot;good&amp;quot;">ngood</a>[ipj]; bi++) {
        ibi=E[b].<a class="code" href="structEigenstates.html#a0a44e079b2e594d09a15d3a1ddd4a35c" title="indexing eigenstates according to &amp;quot;goodness&amp;quot;">index</a>[ipj][bi];
        normb2=E[b].<a class="code" href="structEigenstates.html#aafb83e8289ec1cb2c7e882311c35ea3a" title="many-body norm^2 of eigenstates">norm</a>[ipj][ibi];
        idxb++;
        idxa=-1;
        <span class="keywordflow">for</span> (a=0; a&lt;n; a++)     
          <span class="keywordflow">for</span> (ai=0; ai&lt;E[a].<a class="code" href="structEigenstates.html#a44b4a004824004e5635d83048d875e21" title="number of eigenstates considered as &amp;quot;good&amp;quot;">ngood</a>[ipj]; ai++) {
            iai=E[a].<a class="code" href="structEigenstates.html#a0a44e079b2e594d09a15d3a1ddd4a35c" title="indexing eigenstates according to &amp;quot;goodness&amp;quot;">index</a>[ipj][ai];
            norma2=E[a].<a class="code" href="structEigenstates.html#aafb83e8289ec1cb2c7e882311c35ea3a" title="many-body norm^2 of eigenstates">norm</a>[ipj][iai];
            idxa++;
            N[idxa+idxb*dim] = 0.0;
            H[idxa+idxb*dim] = 0.0;

            <span class="keywordflow">for</span> (k=-<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>; k&lt;=<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>; k=k+2)
              <span class="keywordflow">for</span> (m=-<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>; m&lt;=<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>; m=m+2) {
                N[idxa+idxb*dim] +=
                  conj(E[a].V[ipj][idxjm(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>,m)+iai*(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1)])*
                  obsme[a+b*n][ipj][idxjmk(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>,m,k)].<a class="code" href="structObservablesod.html#a8c9da6cf3aa140f99b6b3f58a8f20182">n</a>*
                  E[b].<a class="code" href="structEigenstates.html#a6e03cbd0f964bc8d73161266831cc874" title="eigenvectors">V</a>[ipj][idxjm(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>,k)+ibi*(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1)]/
                  sqrt(norma2*normb2);
                         
                H[idxa+idxb*dim] +=
                  conj(E[a].V[ipj][idxjm(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>,m)+iai*(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1)])*
                  obsme[a+b*n][ipj][idxjmk(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>,m,k)].<a class="code" href="structObservablesod.html#a8c2c7596d9d5853b8f1701fe351dc300">h</a>*
                  E[b].<a class="code" href="structEigenstates.html#a6e03cbd0f964bc8d73161266831cc874" title="eigenvectors">V</a>[ipj][idxjm(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>,k)+ibi*(<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>+1)]/
                  sqrt(norma2*normb2);

              } 
          }     
      }      

    <a class="code" href="cmat_8c.html#aab30acd19149c3014405da4f585d4bb5">generalizedeigensystem</a>(H, N, dim, thresh, v, V, &amp;d);

    <span class="comment">// we got d eigenstates, filter out the noise</span>
    <span class="comment">// see sortEigenstates</span>

    complex <span class="keywordtype">double</span> norm[d];
    <span class="keywordflow">for</span> (i=0; i&lt;d; i++) {
      norm[i] = 0.0;
      <span class="keywordflow">for</span> (l=0; l&lt;dim; l++)
        <span class="keywordflow">for</span> (k=0; k&lt;dim; k++)
          norm[i] += conj(V[k+i*dim])*N[k+l*dim]*V[l+i*dim];
    }

    <span class="keywordtype">double</span> maxnorm = 0.0;
    <span class="keywordflow">for</span> (i=0; i&lt;d; i++)
      maxnorm = fmax(maxnorm, creal(norm[i]));

    <span class="comment">// for debugging</span>
    <span class="comment">/*</span>
<span class="comment">    for (i=0; i&lt;d; i++)</span>
<span class="comment">      fprintf(stderr, &quot;i: %d, e[i] = %8.3f MeV, n[i] = %7.5f\n&quot;, i, hbc*creal(v[i]), norm[i]);</span>
<span class="comment">    */</span>

    <span class="comment">// merits</span>

    <span class="keyword">struct </span>merit {
      <span class="keywordtype">double</span> <a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a>;
      <span class="keywordtype">int</span> idx;
    } merits[d];

    <span class="keywordflow">for</span> (i=0; i&lt;d; i++) {
      merits[i].idx = i;
      <span class="keywordflow">if</span> (creal(norm[i]) &lt; minnorm*maxnorm)
        merits[i].val = -100000.0;
      <span class="keywordflow">else</span>
        merits[i].val = -creal(v[i]);
    }

    <span class="comment">// sort according to merits value</span>
    qsort(merits, d, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> merit), cmpmerit);

    i=0; <span class="keywordflow">while</span> (i&lt;d &amp;&amp; merits[i].<a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a> &gt; -100000.0) i++;

    <span class="keywordflow">if</span> (i &lt; ei)
      <span class="keywordflow">return</span> EUNDEFINED;

    <span class="keywordtype">double</span> e = -merits[ei].val;

    free(H);
    free(N);
    free(v);
    free(V);

    <span class="keywordflow">return</span> e;
  }
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa1a34cfe1cc65e30c9f60768f7df9a5d"></a><!-- doxytag: member="calcenergymultiprojsel.c::cleanup" ref="aa1a34cfe1cc65e30c9f60768f7df9a5d" args="(int ret)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void cleanup </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ret</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="calcenergymultiprojsel_8c_source.html#l00322">322</a> of file <a class="el" href="calcenergymultiprojsel_8c_source.html">calcenergymultiprojsel.c</a>.</p>

<p>References <a class="el" href="Communication_8c_source.html#l00038">BroadcastTask()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
<span class="preprocessor">#ifdef MPI</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> task=TASKFIN;
  <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);

  MPI_Finalize();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  exit(ret);
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a04dbed99447ff9ce88230b596b204173"></a><!-- doxytag: member="calcenergymultiprojsel.c::energy" ref="a04dbed99447ff9ce88230b596b204173" args="(const Projection *P, const Eigenstates *E, int j, int p, int i)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double energy </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structProjection.html">Projection</a> *&nbsp;</td>
          <td class="paramname"> <em>P</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structEigenstates.html">Eigenstates</a> *&nbsp;</td>
          <td class="paramname"> <em>E</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>j</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>i</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="calcenergymultiprojsel_8c_source.html#l00049">49</a> of file <a class="el" href="calcenergymultiprojsel_8c_source.html">calcenergymultiprojsel.c</a>.</p>

<p>References <a class="el" href="Projection_8h_source.html#l00147">Eigenstates::index</a>, <a class="el" href="Projection_8h_source.html#l00093">Projection::jmax</a>, <a class="el" href="Projection_8h_source.html#l00146">Eigenstates::ngood</a>, and <a class="el" href="Projection_8h_source.html#l00143">Eigenstates::v</a>.</p>

<p>Referenced by <a class="el" href="calcenergymultiprojsel_8c_source.html#l00335">main()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="keywordtype">int</span> ipj = idxpij(P-&gt;<a class="code" href="structProjection.html#aaab8cf237ff5e23d0f7abb05117387fe" title="calculate up to (jmax-1)/2">jmax</a>,p,<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>);
  <span class="keywordtype">int</span> ngood = E-&gt;<a class="code" href="structEigenstates.html#a44b4a004824004e5635d83048d875e21" title="number of eigenstates considered as &amp;quot;good&amp;quot;">ngood</a>[ipj];

  fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);

  <span class="keywordflow">if</span> (!ngood)
    <span class="keywordflow">return</span> EUNDEFINED;

  <span class="keywordflow">if</span> (i&gt;=ngood) 
    i=ngood-1;

  <span class="keywordflow">return</span> E-&gt;<a class="code" href="structEigenstates.html#ade09c5713d0d08f69ed61126f1c8d075" title="energy eigenvalues">v</a>[ipj][E-&gt;<a class="code" href="structEigenstates.html#a0a44e079b2e594d09a15d3a1ddd4a35c" title="indexing eigenstates according to &amp;quot;goodness&amp;quot;">index</a>[ipj][i]];
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0ddf1224851353fc92bfbff6f499fa97"></a><!-- doxytag: member="calcenergymultiprojsel.c::main" ref="a0ddf1224851353fc92bfbff6f499fa97" args="(int argc, char *argv[])" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>argv</em>[]</td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="calcenergymultiprojsel_8c_source.html#l00335">335</a> of file <a class="el" href="calcenergymultiprojsel_8c_source.html">calcenergymultiprojsel.c</a>.</p>

<p>References <a class="el" href="SlaterDet_8h_source.html#l00030">SlaterDet::A</a>, <a class="el" href="Communication_8c_source.html#l00032">BroadcastA()</a>, <a class="el" href="Communication_8c_source.html#l00097">BroadcastInteraction()</a>, <a class="el" href="Communication_8c_source.html#l00038">BroadcastTask()</a>, <a class="el" href="calcenergymultiprojsel_8c_source.html#l00068">calcbasisovlap()</a>, <a class="el" href="Projection_8c_source.html#l01235">calcEigenstates()</a>, <a class="el" href="calcenergymultiprojsel_8c_source.html#l00171">calcenergyeigenvalue()</a>, <a class="el" href="Projection_8c_source.html#l00880">calcexpectprojectedMBME()</a>, <a class="el" href="Projection_8c_source.html#l01488">calcMultiEigenstates()</a>, <a class="el" href="calcenergymultiproj_8c_source.html#l00039">cleanup()</a>, <a class="el" href="Interaction_8h_source.html#l00059">Interaction::cm</a>, <a class="el" href="utils_8c_source.html#l00032">createinfo()</a>, <a class="el" href="calcenergymultiprojsel_8c_source.html#l00049">energy()</a>, <a class="el" href="Symmetry_8c_source.html#l00041">extractSymmetryfromString()</a>, <a class="el" href="utils_8c_source.html#l00046">fprintinfo()</a>, <a class="el" href="Projection_8c_source.html#l00178">fprintProjectinfo()</a>, <a class="el" href="physics_8c_source.html#l00031">hbc</a>, <a class="el" href="Projection_8c_source.html#l01227">initAmplitudes()</a>, <a class="el" href="Projection_8c_source.html#l01212">initEigenstates()</a>, <a class="el" href="ProjectedObservables_8c_source.html#l00042">initOpObservables()</a>, <a class="el" href="Projection_8c_source.html#l00315">initprojectedVector()</a>, <a class="el" href="Projection_8c_source.html#l00102">initProjection()</a>, <a class="el" href="MinimizerDONLP2_8c_source.html#l00071">Int</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00102">j</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00106">minnormkmix</a>, <a class="el" href="Communication_8c_source.html#l00028">mpirank</a>, <a class="el" href="Communication_8c_source.html#l00029">mpisize</a>, <a class="el" href="Projection_8h_source.html#l00153">Amplitudes::n</a>, <a class="el" href="Projection_8h_source.html#l00142">Eigenstates::n</a>, <a class="el" href="HOBasis_8c_source.html#l00049">n</a>, <a class="el" href="ProjectedObservables_8c_source.html#l00031">OpObservables</a>, <a class="el" href="Ovlap_8c_source.html#l00021">OpOvlap</a>, <a class="el" href="MinimizerDONLP2_8c_source.html#l00075">P</a>, <a class="el" href="ProjectionSlave_8c_source.html#l00028">ProjectionSlave()</a>, <a class="el" href="Projection_8c_source.html#l00055">ProjectiontoStr()</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00108">projpar</a>, <a class="el" href="MinimizerDONLP2_8c_source.html#l00076">Q</a>, <a class="el" href="Projection_8c_source.html#l01814">readEigenstatesfromFile()</a>, <a class="el" href="Interaction_8c_source.html#l00045">readInteractionfromFile()</a>, <a class="el" href="calcenergymultiprojsel_8c_source.html#l00290">readorcalcandwriteprojectedMBMEfromtoFile()</a>, <a class="el" href="SlaterDet_8c_source.html#l00162">readSlaterDetfromFile()</a>, <a class="el" href="utils_8c_source.html#l00238">readstringsfromfile()</a>, <a class="el" href="ProjectedObservables_8c_source.html#l00069">showprojectedObservables()</a>, <a class="el" href="Projection_8c_source.html#l01752">sortEigenstates()</a>, <a class="el" href="Symmetry_8c_source.html#l00076">SymmetrytoStr()</a>, and <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00105">threshkmix</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <a class="code" href="utils_8c.html#afef28a69be6bfcf3523c2875ccab3ab7" title="save info about running process">createinfo</a>(argc, argv);

<span class="preprocessor">#ifdef MPI</span>
<span class="preprocessor"></span>  MPI_Init(&amp;argc, &amp;argv);
  MPI_Comm_rank(MPI_COMM_WORLD, &amp;<a class="code" href="Communication_8c.html#a30b130b023ad0c2d9b7b08ccc18345a0">mpirank</a>);
  MPI_Comm_size(MPI_COMM_WORLD, &amp;<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>);

  <span class="comment">// fprintf(stderr, &quot;... [%2d] %s\n&quot;, mpirank, hostname());</span>

  <span class="keywordflow">if</span> (<a class="code" href="Communication_8c.html#a30b130b023ad0c2d9b7b08ccc18345a0">mpirank</a> != 0) {
    <a class="code" href="ProjectionSlave_8c.html#ad2a33164c6cba8b6026a46891933c238">ProjectionSlave</a>();

    MPI_Finalize();
  } <span class="keywordflow">else</span> {
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

  <span class="comment">/* enough arguments ? */</span>

  <span class="keywordflow">if</span> (argc &lt; 3) {
    fprintf(stderr, <span class="stringliteral">&quot;\nusage: %s [OPTIONS] PROJPAR INTERACTION NUCSFILE&quot;</span>
            <span class="stringliteral">&quot;\n   -f FIXNUCSFILE&quot;</span>
            <span class="stringliteral">&quot;\n   -n N           search only for up to N states&quot;</span>
            <span class="stringliteral">&quot;\n   -j JSEL        select for angular momentum JSEL&quot;</span>
            <span class="stringliteral">&quot;\n   -p PSEL        select for parity PSEL [0|1]&quot;</span>
            <span class="stringliteral">&quot;\n   -i ISEL        select for #ISEL&quot;</span>
            <span class="stringliteral">&quot;\n   -o OVLTHRESH   overlap threshold&quot;</span>
            <span class="stringliteral">&quot;\n   -e ENTHRESH    energy threshold [MeV]&quot;</span>
            <span class="stringliteral">&quot;\n   -t THRESH      threshold for SVD\n&quot;</span>, argv[0]);
    exit(-1);
  }

  <span class="keywordtype">int</span> odd;
  <span class="keywordtype">double</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#a194818108e8dc728022f0b313fb483af">threshkmix</a>=0.01;
  <span class="keywordtype">double</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#ae491589abdf73004152c46a1c21cf039">minnormkmix</a>=0.001;
  <span class="keywordtype">int</span> all=0;
  <span class="keywordtype">double</span> threshmulti=0.0000001;
  <span class="keywordtype">double</span> minnormmulti=0.001;
  <span class="keywordtype">double</span> ovlthresh=0.95;
  <span class="keywordtype">double</span> enthresh=0.050/<a class="code" href="physics_8c.html#ac84f9a1ea91a60ec41b71eb31f90eb4c" title="hbarc [MeV fm]">hbc</a>;
  <span class="keywordtype">int</span> nmax=0;
  <span class="comment">// optimize for which quantum numbers</span>
  <span class="keywordtype">int</span> jsel=0, psel=0, isel=0;

  <span class="keywordtype">char</span>* fixnucsfile = NULL;

  <span class="comment">/* manage command-line options */</span>

  <span class="keywordtype">char</span> c;
  <span class="keywordflow">while</span> ((c = getopt(argc, argv, <span class="stringliteral">&quot;f:t:n:j:p:i:o:e:&quot;</span>)) != -1)
    <span class="keywordflow">switch</span> (c) {
    <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:
      fixnucsfile = optarg;
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:
      threshmulti = atof(optarg);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:
      nmax = atoi(optarg);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">&#39;j&#39;</span>:
      jsel = atoi(optarg);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:
      psel = atoi(optarg);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:
      isel = atoi(optarg);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>:
      ovlthresh = atof(optarg);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>:
      enthresh = atof(optarg)/<a class="code" href="physics_8c.html#ac84f9a1ea91a60ec41b71eb31f90eb4c" title="hbarc [MeV fm]">hbc</a>;
      <span class="keywordflow">break</span>;
    }

  <span class="keywordtype">char</span>* <a class="code" href="MinimizerDONLP2multivapp_8c.html#ae51b51057e3a9d5aa3905eed7979dca1">projpar</a> = argv[optind];
  <span class="keywordtype">char</span>* interactionfile = argv[optind+1];
  <span class="keywordtype">char</span>* nucsfile = argv[optind+2];

  <span class="keywordtype">char</span>* mbfile[MAXSTATES];
  <span class="keywordtype">int</span> fixn=0, searchn, <a class="code" href="HOBasis_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, nsel;
  <span class="keywordtype">int</span> i;

  <span class="comment">// are there fixed configs ?</span>
  <span class="keywordflow">if</span> (fixnucsfile) {
    <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#a39a52b93ea85c4935b19580bfe57f60e" title="read list of strings from file">readstringsfromfile</a>(fixnucsfile, &amp;fixn, mbfile)) {
      fprintf(stderr, <span class="stringliteral">&quot;couldn&#39;t open %s\n&quot;</span>, fixnucsfile);
      <a class="code" href="calcenergymultiproj_8c.html#aa1a34cfe1cc65e30c9f60768f7df9a5d">cleanup</a>(-1);
    }
  }
  nsel = fixn;

  <span class="comment">// possibly there are identical states in nucsfile and fixnucsfile</span>
  <span class="comment">// they should be eliminated by the overlap threshold</span>
  <span class="keywordflow">if</span> (<a class="code" href="utils_8c.html#a39a52b93ea85c4935b19580bfe57f60e" title="read list of strings from file">readstringsfromfile</a>(nucsfile, &amp;searchn, &amp;mbfile[fixn])) {
    fprintf(stderr, <span class="stringliteral">&quot;couldn&#39;t open %s\n&quot;</span>, nucsfile);
    <a class="code" href="calcenergymultiproj_8c.html#aa1a34cfe1cc65e30c9f60768f7df9a5d">cleanup</a>(-1);
  }
 
  <span class="comment">// total number of states</span>
  n = fixn + searchn;

  <span class="comment">// which many-body states are selected</span>
  <span class="keywordtype">int</span> idx[n];
  
  <span class="comment">// selected (best) energies for set of i states</span>
  <span class="keywordtype">double</span> esel[n];

  <span class="comment">// maximum number of states to select</span>
  <span class="keywordflow">if</span> (nmax==0) 
    nmax=n;
  <span class="keywordflow">else</span> 
    nmax=fixn+nmax;


  <a class="code" href="structSlaterDet.html" title="Slater Determinant.">SlaterDet</a> <a class="code" href="MinimizerDONLP2_8c.html#ac4f7151b4c1c951d242ff9f8856381a0">Q</a>[n]; 
  <a class="code" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> S[n];

  <span class="keywordflow">for</span> (i=0; i&lt;n; i++) {
    <a class="code" href="Symmetry_8c.html#ab6bcb31ab4271d44a38936dc59c8c258">extractSymmetryfromString</a>(&amp;mbfile[i], &amp;S[i]);
    <span class="keywordflow">if</span> (<a class="code" href="SlaterDet_8c.html#a3ebf34d0b05c3dcde99a34ddb61c49e4">readSlaterDetfromFile</a>(&amp;Q[i], mbfile[i])) {
      fprintf(stderr, <span class="stringliteral">&quot;couldn&#39;t read from %s\n&quot;</span>, mbfile[i]);
      <a class="code" href="calcenergymultiproj_8c.html#aa1a34cfe1cc65e30c9f60768f7df9a5d">cleanup</a>(-1);
    }
  }

  <a class="code" href="structInteraction.html">Interaction</a> <a class="code" href="MinimizerDONLP2_8c.html#ae051dcd567638cf29379a3fec796679c">Int</a>;
  <span class="keywordflow">if</span> (<a class="code" href="Interaction_8c.html#abdf0ac4f8c18e2764035f01c54a76ccf">readInteractionfromFile</a>(&amp;Int, interactionfile)) {
    fprintf(stderr, <span class="stringliteral">&quot;couldn&#39;t read Interaction from %s\n&quot;</span>, interactionfile);
    <a class="code" href="calcenergymultiproj_8c.html#aa1a34cfe1cc65e30c9f60768f7df9a5d">cleanup</a>(-1);
  }
  Int.<a class="code" href="structInteraction.html#af2e544149baa09761156dcaeed81a000">cm</a> = 1; 

  <span class="comment">// odd number of nucleons ?</span>
  odd = Q[0].<a class="code" href="structSlaterDet.html#a608c038b00ef605b3871e920459ee4f3" title="number of nucleons">A</a> % 2;

  <span class="comment">// integer or half-integer jsel - compatible with odd ?</span>
  <span class="keywordflow">if</span> (odd != jsel %2) {
    fprintf(stderr, <span class="stringliteral">&quot;not possible to project on j=%d\n&quot;</span>, jsel);
    <a class="code" href="calcenergymultiproj_8c.html#aa1a34cfe1cc65e30c9f60768f7df9a5d">cleanup</a>(-1);
  }

<span class="preprocessor">#ifdef MPI</span>
<span class="preprocessor"></span>  <span class="keywordtype">int</span> task=TASKSTART;
  <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);

  <a class="code" href="Communication_8c.html#a3aa9f627ca78542397894af7656f94bb">BroadcastInteraction</a>(&amp;Int);
  <a class="code" href="Communication_8c.html#adeb95ea5dfe9393735dbfbdc6534a37e" title="broadcast size of nucleus">BroadcastA</a>(&amp;Q[0].A);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="comment">// Projection parameters</span>
  <a class="code" href="structProjection.html" title="Projection.">Projection</a> <a class="code" href="MinimizerDONLP2_8c.html#a937218b25a684555a6d94a5058c7b358">P</a>;
  <a class="code" href="Projection_8c.html#a8933a4a47f0572f2e2943562cd45aac5">initProjection</a>(&amp;P, odd, projpar);

  <a class="code" href="ProjectedObservables_8c.html#ac2c3f2a4dc7d5330b2ebf9b7a1fe0a27">initOpObservables</a>(&amp;Int);

  <span class="keywordtype">int</span> a,b; 

  <span class="comment">// matrix elements</span>
  complex <span class="keywordtype">double</span>** ovlme[n*n];
  <a class="code" href="structObservablesod.html">Observablesod</a>** obsme[n*n];

  <span class="comment">// keep track of already calculated matrix elements</span>
  <span class="keywordtype">int</span> ovlmedone[n*n];
  <span class="keywordtype">int</span> obsmedone[n*n];

  <span class="comment">// initialize space for matrix elements only on demand</span>
  <span class="keywordflow">for</span> (b=0; b&lt;n; b++)   
    <span class="keywordflow">for</span> (a=0; a&lt;n; a++) {
      ovlmedone[a+b*n] = 0; obsmedone[a+b*n] = 0;
      ovlme[a+b*n] = NULL; obsme[a+b*n] = NULL; 
      <span class="comment">// ovlme[a+b*n] = initprojectedMBME(&amp;P, &amp;OpOvlap);</span>
      <span class="comment">// obsme[a+b*n] = initprojectedMBME(&amp;P, &amp;OpObservables);</span>
    }

  <span class="comment">// we read/calculate the diagonal matrix elements right at the beginning</span>

  <span class="keywordflow">for</span> (a=0; a&lt;n; a++) {

    <a class="code" href="calcenergymultiprojsel_8c.html#a439e0eb195e5140de02cfb5b3cbcb79b">readorcalcandwriteprojectedMBMEfromtoFile</a>(mbfile[a], mbfile[a], &amp;P, &amp;<a class="code" href="Ovlap_8c.html#a37b813e25928356d7317373149831c00">OpOvlap</a>, 
                                              &amp;Q[a], &amp;Q[a], S[a], S[a], &amp;ovlme[a+a*n]);
    ovlmedone[a+a*n] = 1;
    
    <a class="code" href="calcenergymultiprojsel_8c.html#a439e0eb195e5140de02cfb5b3cbcb79b">readorcalcandwriteprojectedMBMEfromtoFile</a>(mbfile[a], mbfile[a], &amp;P, &amp;<a class="code" href="ProjectedObservables_8c.html#a581984c01d721cce94a02880b04d7128">OpObservables</a>, 
                                              &amp;Q[a], &amp;Q[a], S[a], S[a], &amp;obsme[a+a*n]);
    obsmedone[a+a*n] = 1;
  }

  <span class="comment">// read or calculate the Eigenstates</span>
      
  <span class="keywordtype">int</span> allp=0;
  <a class="code" href="structEigenstates.html" title="Container for Eigenstates.">Eigenstates</a> Ep[n];
  <a class="code" href="structObservablesod.html">Observablesod</a>** obsp = <a class="code" href="Projection_8c.html#ab04781bf318f9779ad81b00b7d9b1837">initprojectedVector</a>(&amp;P, &amp;<a class="code" href="ProjectedObservables_8c.html#a581984c01d721cce94a02880b04d7128">OpObservables</a>, 1);
  
  <span class="keywordflow">for</span> (i=0; i&lt;n; i++) {
    <span class="keywordflow">if</span> (<a class="code" href="Projection_8c.html#a5935cc6b0a5d47d441ca31d6fedbe5cc">readEigenstatesfromFile</a>(mbfile[i], &amp;P, &amp;Ep[i], 1)) {
      fprintf(stderr, <span class="stringliteral">&quot;... calculating Eigenstates for %s\n&quot;</span>, mbfile[i]);
      <a class="code" href="Projection_8c.html#a9be2f82e183827f27b5edbefcb794740">initEigenstates</a>(&amp;P, &amp;Ep[i], 1);
      <a class="code" href="Projection_8c.html#ae1d7e6ab780b680233363090cdb2764f">calcEigenstates</a>(&amp;P, &amp;Int, &amp;obsme[i+i*n], &amp;Ep[i], threshkmix);
      <a class="code" href="Projection_8c.html#a8496ec48cbc243bb807deeb60339a251">calcexpectprojectedMBME</a>(&amp;P, &amp;<a class="code" href="ProjectedObservables_8c.html#a581984c01d721cce94a02880b04d7128">OpObservables</a>, &amp;obsme[i+i*n], &amp;S[i], &amp;Ep[i], obsp);
      <a class="code" href="Projection_8c.html#a465ddb73457c8835e9a944d35b54f79a">sortEigenstates</a>(&amp;P, &amp;Int, obsp, &amp;Ep[i], minnormkmix, allp);
    }
  }


  <span class="comment">// common root for all output files</span>
  <span class="keywordtype">char</span> outfile[1024];
  <span class="keywordflow">if</span> (fixn &gt; 0)
    sprintf(outfile, <span class="stringliteral">&quot;%s--%s--sel-%d-%d-%d&quot;</span>, fixnucsfile, nucsfile, jsel, psel, isel);
  <span class="keywordflow">else</span>
    sprintf(outfile, <span class="stringliteral">&quot;%s--sel-%d-%d-%d&quot;</span>, nucsfile, jsel, psel, isel);

  <span class="comment">// the log file</span>
  <span class="keywordtype">char</span> nucssellogfile[1024];
  sprintf(nucssellogfile, <span class="stringliteral">&quot;%s.log&quot;</span>, outfile);

  FILE* logfp;
  <span class="keywordflow">if</span> (!(logfp = fopen(nucssellogfile, <span class="stringliteral">&quot;w&quot;</span>))) {
    fprintf(stderr, <span class="stringliteral">&quot;couldn&#39;t open %s for writing\n&quot;</span>, nucssellogfile);
    <a class="code" href="calcenergymultiproj_8c.html#aa1a34cfe1cc65e30c9f60768f7df9a5d">cleanup</a>(-1);
  }  
  setlinebuf(logfp);
  <a class="code" href="utils_8c.html#ae3c710edac30cf257199e6595212a75a" title="print info about running process">fprintinfo</a>(logfp);

  fprintf(logfp, <span class="stringliteral">&quot;\n&quot;</span>);
  fprintf(logfp, <span class="stringliteral">&quot;ovlap threshold :  %5.3f\n&quot;</span>, ovlthresh);
  fprintf(logfp, <span class="stringliteral">&quot;energy threshold:  %5.3f MeV\n&quot;</span>, <a class="code" href="physics_8c.html#ac84f9a1ea91a60ec41b71eb31f90eb4c" title="hbarc [MeV fm]">hbc</a>*enthresh);


  <span class="comment">// Eselp and obsmesel are pointers to the selected</span>
  <span class="comment">// Eigenstates and matrixelements</span>
  <a class="code" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> Ssel[n];
  <a class="code" href="structEigenstates.html" title="Container for Eigenstates.">Eigenstates</a> Eselp[n] ;
  complex <span class="keywordtype">double</span>** ovlmesel[n*n];
  <a class="code" href="structObservablesod.html">Observablesod</a>** obsmesel[n*n];
  <a class="code" href="structObservablesod.html">Observablesod</a>** obs;
  
  <a class="code" href="structEigenstates.html" title="Container for Eigenstates.">Eigenstates</a> multiE;
  <a class="code" href="structAmplitudes.html">Amplitudes</a> multiA;

  <a class="code" href="Projection_8c.html#a9be2f82e183827f27b5edbefcb794740">initEigenstates</a>(&amp;P, &amp;multiE, n);
  <a class="code" href="Projection_8c.html#a24150e1691aa16292612bec682cca3ae">initAmplitudes</a>(&amp;P, &amp;multiA, n);
  obs = <a class="code" href="Projection_8c.html#ab04781bf318f9779ad81b00b7d9b1837">initprojectedVector</a>(&amp;P, &amp;<a class="code" href="ProjectedObservables_8c.html#a581984c01d721cce94a02880b04d7128">OpObservables</a>, n);

  <span class="keywordtype">int</span> imin;
  <span class="keywordtype">double</span> e, ovl, emin = EUNDEFINED;

  <span class="keywordflow">if</span> (fixn) {

    <span class="comment">// are there fixed states ?</span>

    <span class="keywordflow">for</span> (i=0; i&lt;fixn; i++)
      idx[i] = i;

    multiE.<a class="code" href="structEigenstates.html#aa5deea949876b2d562c5c5129c119e76">n</a> = fixn;
    multiA.<a class="code" href="structAmplitudes.html#aeb28e7c61eb781e59b43e00dabb8bf79">n</a> = fixn;

    <span class="comment">// read/calc overlap matrix elements </span>
    <span class="keywordflow">for</span> (b=0; b&lt;fixn; b++)
      <span class="keywordflow">for</span> (a=0; a&lt;fixn; a++) {
        <span class="keywordflow">if</span> (!ovlmedone[idx[a]+idx[b]*n]) {
          <a class="code" href="calcenergymultiprojsel_8c.html#a439e0eb195e5140de02cfb5b3cbcb79b">readorcalcandwriteprojectedMBMEfromtoFile</a>(mbfile[idx[a]], mbfile[idx[b]], 
                                                    &amp;P, &amp;<a class="code" href="Ovlap_8c.html#a37b813e25928356d7317373149831c00">OpOvlap</a>, 
                                                    &amp;Q[idx[a]], &amp;Q[idx[b]], 
                                                    S[idx[a]], S[idx[b]], 
                                                    &amp;ovlme[idx[a]+idx[b]*n]);
          ovlmedone[idx[a]+idx[b]*n] = 1;         
        }
        <span class="keywordflow">if</span> (!obsmedone[idx[a]+idx[b]*n]) {
          <a class="code" href="calcenergymultiprojsel_8c.html#a439e0eb195e5140de02cfb5b3cbcb79b">readorcalcandwriteprojectedMBMEfromtoFile</a>(mbfile[idx[a]], mbfile[idx[b]], 
                                                    &amp;P, &amp;<a class="code" href="ProjectedObservables_8c.html#a581984c01d721cce94a02880b04d7128">OpObservables</a>, 
                                                    &amp;Q[idx[a]], &amp;Q[idx[b]], 
                                                    S[idx[a]], S[idx[b]], 
                                                    &amp;obsme[idx[a]+idx[b]*n]);
          obsmedone[idx[a]+idx[b]*n] = 1;         
        }
      }    

    <span class="keywordflow">for</span> (a=0; a&lt;fixn; a++) {
      Ssel[a] = S[idx[a]];
      Eselp[a] = Ep[idx[a]];
    }
                      
    <span class="keywordflow">for</span> (b=0; b&lt;fixn; b++)
      <span class="keywordflow">for</span> (a=0; a&lt;fixn; a++) {
        ovlmesel[a+b*fixn] = ovlme[idx[a]+idx[b]*n];
        obsmesel[a+b*fixn] = obsme[idx[a]+idx[b]*n];
      }

    e = <a class="code" href="calcenergymultiprojsel_8c.html#ab452b700e25a21cee07421320c343874">calcenergyeigenvalue</a>(&amp;P, Eselp, obsmesel, fixn, jsel, psel, isel, threshmulti, minnormmulti);

    esel[fixn-1] = e;

    fprintf(logfp, <span class="stringliteral">&quot;\n ... taking %2d fix configs\n\n&quot;</span>, fixn);
    fprintf(logfp, <span class="stringliteral">&quot;\n                      energy: %8.3f MeV\n&quot;</span>, <a class="code" href="physics_8c.html#ac84f9a1ea91a60ec41b71eb31f90eb4c" title="hbarc [MeV fm]">hbc</a>*e);

  } <span class="keywordflow">else</span> {

    <span class="comment">// find state with lowest energy</span>

    imin=-1;
    <span class="keywordflow">for</span> (a=0; a&lt;n; a++) {
      e=<a class="code" href="calcenergymultiprojsel_8c.html#a04dbed99447ff9ce88230b596b204173">energy</a>(&amp;P, &amp;Ep[a], jsel, psel, isel);

      fprintf(stderr, <span class="stringliteral">&quot;[%2d] - %s - energy:  %8.3f MeV\n&quot;</span>,
              a, mbfile[a], <a class="code" href="physics_8c.html#ac84f9a1ea91a60ec41b71eb31f90eb4c" title="hbarc [MeV fm]">hbc</a>*e);

      <span class="keywordflow">if</span> (e &lt; emin) {
        emin = e;
        imin = a;
      }
    }
    
    idx[0] = imin;
    esel[0] = emin;
    nsel = 1;

    fprintf(logfp, <span class="stringliteral">&quot;\n\n ... selecting  1 config\n\n&quot;</span>);
    fprintf(logfp, <span class="stringliteral">&quot;selected [%2d] - %s - energy:  %8.3f MeV\n&quot;</span>, 
            imin, mbfile[imin], <a class="code" href="physics_8c.html#ac84f9a1ea91a60ec41b71eb31f90eb4c" title="hbarc [MeV fm]">hbc</a>*emin);
  }
   
  <span class="comment">// now select additional configs</span>

  <span class="keywordtype">int</span> done=0;
  <span class="keywordflow">while</span> (!done &amp;&amp; nsel &lt; nmax) {

    fprintf(logfp, <span class="stringliteral">&quot;\n\n ... selecting %2d configs\n\n&quot;</span>, nsel+1);

    <span class="comment">// set correct dimension for eigenstates and amplitudes</span>
    multiE.<a class="code" href="structEigenstates.html#aa5deea949876b2d562c5c5129c119e76">n</a> = nsel+1;
    multiA.<a class="code" href="structAmplitudes.html#aeb28e7c61eb781e59b43e00dabb8bf79">n</a> = nsel+1;

    <span class="keywordflow">for</span> (a=0; a&lt;nsel; a++) {
      Ssel[a] = S[idx[a]];
      Eselp[a] = Ep[idx[a]];
    }
                      
    <span class="keywordflow">for</span> (b=0; b&lt;nsel; b++)
      <span class="keywordflow">for</span> (a=0; a&lt;nsel; a++) {
        ovlmesel[a+b*(nsel+1)] = ovlme[idx[a]+idx[b]*n];
        obsmesel[a+b*(nsel+1)] = obsme[idx[a]+idx[b]*n];
      }

    <span class="comment">// find the config which lowers the energy the most and has not too much overlap</span>
    <span class="comment">// with already selected configurations</span>

    imin = -1;
    emin = EUNDEFINED;
    <span class="keywordflow">for</span> (i=fixn; i&lt;n; i++) {
      
      <span class="comment">// is i already selected ?</span>
      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>=0; <a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>&lt;nsel; <a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>++)
        <span class="keywordflow">if</span> (idx[<a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>] == i)
          <span class="keywordflow">goto</span> next;

      <span class="comment">// read/calc overlap matrix elements </span>
      <span class="keywordflow">for</span> (a=0; a&lt;nsel; a++) {
        <span class="keywordflow">if</span> (!ovlmedone[idx[a]+i*n]) {
          <a class="code" href="calcenergymultiprojsel_8c.html#a439e0eb195e5140de02cfb5b3cbcb79b">readorcalcandwriteprojectedMBMEfromtoFile</a>(mbfile[idx[a]], mbfile[i], 
                                                    &amp;P, &amp;<a class="code" href="Ovlap_8c.html#a37b813e25928356d7317373149831c00">OpOvlap</a>, 
                                                    &amp;Q[idx[a]], &amp;Q[i], S[idx[a]], S[i], 
                                                    &amp;ovlme[idx[a]+i*n]);
          ovlmedone[idx[a]+i*n] = 1;      
        }
        <span class="keywordflow">if</span> (!ovlmedone[i+idx[a]*n]) {
          <a class="code" href="calcenergymultiprojsel_8c.html#a439e0eb195e5140de02cfb5b3cbcb79b">readorcalcandwriteprojectedMBMEfromtoFile</a>(mbfile[i], mbfile[idx[a]], 
                                                    &amp;P, &amp;<a class="code" href="Ovlap_8c.html#a37b813e25928356d7317373149831c00">OpOvlap</a>, 
                                                    &amp;Q[i], &amp;Q[idx[a]], S[i], S[idx[a]], 
                                                    &amp;ovlme[i+idx[a]*n]);
          ovlmedone[i+idx[a]*n] = 1;      
        }
      }

      Ssel[nsel] = S[i];
      Eselp[nsel] = Ep[i];
      <span class="keywordflow">for</span> (a=0; a&lt;nsel; a++) {
        ovlmesel[a+nsel*(nsel+1)] = ovlme[idx[a]+i*n];
        ovlmesel[nsel+a*(nsel+1)] = ovlme[i+idx[a]*n];
      }
      ovlmesel[nsel+nsel*(nsel+1)] = ovlme[i+i*n];

      <span class="comment">// if overlap with already selected basis states to big skip</span>
      ovl = <a class="code" href="calcenergymultiprojsel_8c.html#a9e8701775617dc23c556aec80298eb44">calcbasisovlap</a>(&amp;P, Eselp, ovlmesel, nsel+1, jsel, psel);
      fprintf(logfp, <span class="stringliteral">&quot;[%2d]     ovlap:    %6.3f\t&quot;</span>, i, ovl);
      <span class="keywordflow">if</span> (ovl &gt; ovlthresh) {
        fprintf(logfp, <span class="stringliteral">&quot;\n&quot;</span>);
        <span class="keywordflow">goto</span> next;
      }

      <span class="comment">// read/calc observables matrix elements </span>
      <span class="keywordflow">for</span> (a=0; a&lt;nsel; a++) {
        <span class="keywordflow">if</span> (!obsmedone[idx[a]+i*n]) {
          <a class="code" href="calcenergymultiprojsel_8c.html#a439e0eb195e5140de02cfb5b3cbcb79b">readorcalcandwriteprojectedMBMEfromtoFile</a>(mbfile[idx[a]], mbfile[i], 
                                                    &amp;P, &amp;<a class="code" href="ProjectedObservables_8c.html#a581984c01d721cce94a02880b04d7128">OpObservables</a>, 
                                                    &amp;Q[idx[a]], &amp;Q[i], S[idx[a]], S[i], 
                                                    &amp;obsme[idx[a]+i*n]);
          obsmedone[idx[a]+i*n] = 1;      
        }
        <span class="keywordflow">if</span> (!obsmedone[i+idx[a]*n]) {
          <a class="code" href="calcenergymultiprojsel_8c.html#a439e0eb195e5140de02cfb5b3cbcb79b">readorcalcandwriteprojectedMBMEfromtoFile</a>(mbfile[i], mbfile[idx[a]], 
                                                    &amp;P, &amp;<a class="code" href="ProjectedObservables_8c.html#a581984c01d721cce94a02880b04d7128">OpObservables</a>, 
                                                    &amp;Q[i], &amp;Q[idx[a]], S[i], S[idx[a]], 
                                                    &amp;obsme[i+idx[a]*n]);
          obsmedone[i+idx[a]*n] = 1;      
        }
      }
      
      <span class="keywordflow">for</span> (a=0; a&lt;nsel; a++) {
        obsmesel[a+nsel*(nsel+1)] = obsme[idx[a]+i*n];
        obsmesel[nsel+a*(nsel+1)] = obsme[i+idx[a]*n];
      }
      obsmesel[nsel+nsel*(nsel+1)] = obsme[i+i*n];

      e = <a class="code" href="calcenergymultiprojsel_8c.html#ab452b700e25a21cee07421320c343874">calcenergyeigenvalue</a>(&amp;P, Eselp, obsmesel, nsel+1, jsel, psel, isel, threshmulti, minnormmulti);

      fprintf(logfp, <span class="stringliteral">&quot;        energy:  %8.3f MeV\n&quot;</span>, <a class="code" href="physics_8c.html#ac84f9a1ea91a60ec41b71eb31f90eb4c" title="hbarc [MeV fm]">hbc</a>*e);

      <span class="keywordflow">if</span> (e &lt; emin) {
        imin = i;
        emin = e;
      }
      
    next:
      ;
    }
    
    <span class="keywordflow">if</span> (emin &lt; esel[nsel-1]-enthresh) {
      idx[nsel] = imin;
      esel[nsel] = emin;

      fprintf(logfp, <span class="stringliteral">&quot;\nselected [%2d] - %s - energy: %8.3f MeV\n&quot;</span>,
              imin, mbfile[imin], <a class="code" href="physics_8c.html#ac84f9a1ea91a60ec41b71eb31f90eb4c" title="hbarc [MeV fm]">hbc</a>*emin);

      Ssel[nsel+1] = S[imin];
      Eselp[nsel+1] = Ep[imin];
      <span class="keywordflow">for</span> (a=0; a&lt;nsel; a++) {
        ovlmesel[a+nsel*(nsel+1)] = ovlme[idx[a]+imin*n];
        ovlmesel[nsel+a*(nsel+1)] = ovlme[imin+idx[a]*n];
      }
      ovlmesel[nsel+nsel*(nsel+1)] = ovlme[imin+imin*n];
      <span class="keywordflow">for</span> (a=0; a&lt;nsel; a++) {
        obsmesel[a+nsel*(nsel+1)] = obsme[idx[a]+imin*n];
        obsmesel[nsel+a*(nsel+1)] = obsme[imin+idx[a]*n];
      }
      obsmesel[nsel+nsel*(nsel+1)] = obsme[imin+imin*n];

      nsel++;
      
      <span class="comment">// solve the eigenvalue problem</span>
      <a class="code" href="Projection_8c.html#a056b9a28cb7f2d352eb665582e9be9fb">calcMultiEigenstates</a>(&amp;P, &amp;Int, obsmesel, &amp;Eselp, &amp;multiE, &amp;multiA, threshmulti);

      <span class="comment">// calculate expectation values</span>
      <a class="code" href="Projection_8c.html#a8496ec48cbc243bb807deeb60339a251">calcexpectprojectedMBME</a>(&amp;P, &amp;<a class="code" href="ProjectedObservables_8c.html#a581984c01d721cce94a02880b04d7128">OpObservables</a>, obsmesel, Ssel, &amp;multiE, obs);

      <span class="comment">// sort Eigenstates</span>
      <a class="code" href="Projection_8c.html#a465ddb73457c8835e9a944d35b54f79a">sortEigenstates</a>(&amp;P, &amp;Int, obs, &amp;multiE, minnormmulti, all);


      <span class="comment">// create nucsfile with selected configs</span>
      
      <span class="keywordtype">char</span> nucsselfile[1024];
      sprintf(nucsselfile, <span class="stringliteral">&quot;%s--%d&quot;</span>, outfile, nsel);
      FILE *outfp;
      <span class="keywordflow">if</span> (!(outfp = fopen(nucsselfile, <span class="stringliteral">&quot;w&quot;</span>))) {
        fprintf(stderr, <span class="stringliteral">&quot;couldn&#39;t open %s for writing\n&quot;</span>, nucsselfile);
        <a class="code" href="calcenergymultiproj_8c.html#aa1a34cfe1cc65e30c9f60768f7df9a5d">cleanup</a>(-1);
      }
      <span class="keywordflow">for</span> (a=0; a&lt;nsel; a++)
        <span class="keywordflow">if</span> (S[idx[a]])
          fprintf(outfp, <span class="stringliteral">&quot;%s:%s\n&quot;</span>, <a class="code" href="Symmetry_8c.html#a57aa62a08fd12aa6fd7da2355ffb0ea0" title="get String with Symmetry">SymmetrytoStr</a>(S[idx[a]]), mbfile[idx[a]]);
        <span class="keywordflow">else</span>
          fprintf(outfp, <span class="stringliteral">&quot;%s\n&quot;</span>, mbfile[idx[a]]);
      fclose(outfp);

      <span class="keywordtype">char</span> nucsselprojfile[1024];
      sprintf(nucsselprojfile, <span class="stringliteral">&quot;%s.multi-%s&quot;</span>, nucsselfile, <a class="code" href="Projection_8c.html#ac87bb7fb183abeb15fc0454df5babd55">ProjectiontoStr</a>(&amp;P));
      <span class="keywordflow">if</span> (!(outfp = fopen(nucsselprojfile, <span class="stringliteral">&quot;w&quot;</span>))) {
        fprintf(stderr, <span class="stringliteral">&quot;couldn&#39;t open %s for writing\n&quot;</span>, nucsselprojfile);
        <a class="code" href="calcenergymultiproj_8c.html#aa1a34cfe1cc65e30c9f60768f7df9a5d">cleanup</a>(-1);
      }
      <a class="code" href="utils_8c.html#ae3c710edac30cf257199e6595212a75a" title="print info about running process">fprintinfo</a>(outfp);
      <a class="code" href="Projection_8c.html#af11f2a70292f93f6b5983cfc4f26d774">fprintProjectinfo</a>(outfp, &amp;P);
      <a class="code" href="ProjectedObservables_8c.html#a13c75c44513731610372de1de6980f9b">showprojectedObservables</a>(outfp, &amp;P, &amp;Int, &amp;Q[0], obs, &amp;multiE, &amp;multiA, <span class="stringliteral">&quot;&quot;</span>);
      fclose(outfp);
      
    } <span class="keywordflow">else</span> {

      fprintf(logfp, <span class="stringliteral">&quot;\n\n... no many-body state lowers energy enough, stopping here\n&quot;</span>);
      <span class="comment">// indicate we have finished</span>
      <span class="keywordtype">char</span> nucsselfinfile[1024];
      sprintf(nucsselfinfile, <span class="stringliteral">&quot;%s.finished&quot;</span>, outfile);

      FILE* finfp;
      <span class="keywordflow">if</span> (!(finfp = fopen(nucsselfinfile, <span class="stringliteral">&quot;w&quot;</span>))) {
        <span class="keywordflow">break</span>;
      }
      fclose(finfp);

      done = 1;
    }

  }

  fclose(logfp);

  <a class="code" href="calcenergymultiproj_8c.html#aa1a34cfe1cc65e30c9f60768f7df9a5d">cleanup</a>(0);

<span class="preprocessor">#ifdef MPI</span>
<span class="preprocessor"></span>  }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a439e0eb195e5140de02cfb5b3cbcb79b"></a><!-- doxytag: member="calcenergymultiprojsel.c::readorcalcandwriteprojectedMBMEfromtoFile" ref="a439e0eb195e5140de02cfb5b3cbcb79b" args="(const char *mbfile, const char *mbfilep, const Projection *P, const ManyBodyOperator *Op, const SlaterDet *Q, const SlaterDet *Qp, Symmetry S, Symmetry Sp, const void **mbme)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void readorcalcandwriteprojectedMBMEfromtoFile </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>mbfile</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>mbfilep</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structProjection.html">Projection</a> *&nbsp;</td>
          <td class="paramname"> <em>P</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structManyBodyOperator.html">ManyBodyOperator</a> *&nbsp;</td>
          <td class="paramname"> <em>Op</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structSlaterDet.html">SlaterDet</a> *&nbsp;</td>
          <td class="paramname"> <em>Q</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structSlaterDet.html">SlaterDet</a> *&nbsp;</td>
          <td class="paramname"> <em>Qp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a>&nbsp;</td>
          <td class="paramname"> <em>S</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a>&nbsp;</td>
          <td class="paramname"> <em>Sp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const void **&nbsp;</td>
          <td class="paramname"> <em>mbme</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="calcenergymultiprojsel_8c_source.html#l00290">290</a> of file <a class="el" href="calcenergymultiprojsel_8c_source.html">calcenergymultiprojsel.c</a>.</p>

<p>References <a class="el" href="Projection_8c_source.html#l00605">calcprojectedMBME()</a>, <a class="el" href="Projectionmpi_8c_source.html#l00037">calcprojectedMBMEmpi()</a>, <a class="el" href="Projection_8c_source.html#l00309">initprojectedMBME()</a>, <a class="el" href="MinimizerDONLP2_8c_source.html#l00071">Int</a>, <a class="el" href="Interaction_8h_source.html#l00057">Interaction::mescaling</a>, <a class="el" href="Projection_8h_source.html#l00112">ManyBodyOperator::name</a>, <a class="el" href="Projection_8h_source.html#l00117">ManyBodyOperator::par</a>, <a class="el" href="Projection_8c_source.html#l00526">readprojectedMBMEfromFile()</a>, <a class="el" href="ProjectedObservables_8c_source.html#l00053">scaleprojectedObservablesMBME()</a>, and <a class="el" href="Projection_8c_source.html#l00390">writeprojectedMBMEtoFile()</a>.</p>

<p>Referenced by <a class="el" href="calcenergymultiprojsel_8c_source.html#l00335">main()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="comment">// allocate space</span>
  *mbme = <a class="code" href="Projection_8c.html#acef8d2b9b483edf18c061e6c4fb464d2" title="store projected MEs between two ManyBody states">initprojectedMBME</a>(P, Op);

  <span class="keywordflow">if</span> (<a class="code" href="Projection_8c.html#a5fd023e0c53857a334555f58605fb039">readprojectedMBMEfromFile</a>(mbfile, mbfilep, P, Op, S, Sp, *mbme)) {
<span class="preprocessor">#ifdef MPI</span>
<span class="preprocessor"></span>    <a class="code" href="Projectionmpi_8c.html#a3974ccaf7a9568d401f16c2c9655d955">calcprojectedMBMEmpi</a>(P, Op, Q, Qp, S, Sp, *mbme); 
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    <a class="code" href="Projection_8c.html#a044ac20ed8962994aa88e59cbc93870e">calcprojectedMBME</a>(P, Op, Q, Qp, S, Sp, *mbme); 
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    <a class="code" href="Projection_8c.html#a9722bff3ee0d982f58d704b1e6c5f205">writeprojectedMBMEtoFile</a>(mbfile, mbfilep, P, Op, S, Sp, *mbme); 
  }

  <span class="comment">// scale interaction matrix elements</span>

  <span class="keywordflow">if</span> (!strncmp(Op-&gt;<a class="code" href="structManyBodyOperator.html#a4262723cd836949c28d7b922bc7178cd" title="uniquely identify operator including parameters">name</a>, <span class="stringliteral">&quot;Observables&quot;</span>, 11)) {
    <a class="code" href="structInteraction.html">Interaction</a>* <a class="code" href="MinimizerDONLP2_8c.html#ae051dcd567638cf29379a3fec796679c">Int</a> = Op-&gt;<a class="code" href="structManyBodyOperator.html#a05268b1b149040fd992263f2e22de7ec">par</a>;

    <span class="keywordflow">if</span> (Int-&gt;<a class="code" href="structInteraction.html#adf9d4566a2cab90de4c9bdc4d04102cc" title="are matrix elements to be scaled ?">mescaling</a>) {
      <a class="code" href="ProjectedObservables_8c.html#a99457fe29b375b97c95345b754d45001">scaleprojectedObservablesMBME</a>(P, Int, *mbme);
    }
  }
        
}
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1ee8c1526a6c435703213460fa61ae2b"></a><!-- doxytag: member="calcenergymultiprojsel.c::SQR" ref="a1ee8c1526a6c435703213460fa61ae2b" args="(int i)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int SQR </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>i</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [inline]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="calcenergymultiprojsel_8c_source.html#l00045">45</a> of file <a class="el" href="calcenergymultiprojsel_8c_source.html">calcenergymultiprojsel.c</a>.</p>

<p><div class="fragment"><pre class="fragment">{ <span class="keywordflow">return</span> i*i; }
</pre></div></p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Dec 4 2012 14:05:35 for FMD by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
