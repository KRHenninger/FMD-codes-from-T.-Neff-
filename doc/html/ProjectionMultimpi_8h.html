<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>FMD: fmdmpi/ProjectionMultimpi.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<h1>fmdmpi/ProjectionMultimpi.h File Reference</h1>  </div>
</div>
<div class="contents">
<code>#include &quot;<a class="el" href="SlaterDet_8h_source.html">fmd/SlaterDet.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="MultiSlaterDet_8h_source.html">fmd/MultiSlaterDet.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="Projection_8h_source.html">fmd/Projection.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="Symmetry_8h_source.html">fmd/Symmetry.h</a>&quot;</code><br/>

<p><a href="ProjectionMultimpi_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="ProjectionMultimpi_8h.html#a38c84ceb9bf621ef547baf4b214c5f87">calcprojectedMultiMBMEmpi</a> (const <a class="el" href="structProjection.html">Projection</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#a937218b25a684555a6d94a5058c7b358">P</a>, const <a class="el" href="structManyBodyOperator.html">ManyBodyOperator</a> *Op, const <a class="el" href="struct__MSD__.html">MultiSlaterDet</a> *MBA, const <a class="el" href="struct__MSD__.html">MultiSlaterDet</a> *MBB, void **mbme)</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>angular momentum projection of matrix elements MPI version</p>
<p>(c) 2003, 2004, 2005 Thomas Neff </p>

<p>Definition in file <a class="el" href="ProjectionMultimpi_8h_source.html">ProjectionMultimpi.h</a>.</p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a38c84ceb9bf621ef547baf4b214c5f87"></a><!-- doxytag: member="ProjectionMultimpi.h::calcprojectedMultiMBMEmpi" ref="a38c84ceb9bf621ef547baf4b214c5f87" args="(const Projection *P, const ManyBodyOperator *Op, const MultiSlaterDet *MBA, const MultiSlaterDet *MBB, void **mbme)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calcprojectedMultiMBMEmpi </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structProjection.html">Projection</a> *&nbsp;</td>
          <td class="paramname"> <em>P</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structManyBodyOperator.html">ManyBodyOperator</a> *&nbsp;</td>
          <td class="paramname"> <em>Op</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="struct__MSD__.html">MultiSlaterDet</a> *&nbsp;</td>
          <td class="paramname"> <em>MBA</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="struct__MSD__.html">MultiSlaterDet</a> *&nbsp;</td>
          <td class="paramname"> <em>MBB</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void **&nbsp;</td>
          <td class="paramname"> <em>mbme</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="ProjectionMultimpi_8c_source.html#l00074">74</a> of file <a class="el" href="ProjectionMultimpi_8c_source.html">ProjectionMultimpi.c</a>.</p>

<p>References <a class="el" href="cmprojection_8c_source.html#l00128">_estimateacm()</a>, <a class="el" href="angprojection_8c_source.html#l00092">_estimateangkappa()</a>, <a class="el" href="angprojection_8c_source.html#l00125">_getangkappacrit()</a>, <a class="el" href="angprojection_8c_source.html#l00131">_initangintegration()</a>, <a class="el" href="cmprojection_8c_source.html#l00147">_initcmintegration()</a>, <a class="el" href="MultiSlaterDet_8h_source.html#l00037">_MSD_::A</a>, <a class="el" href="SlaterDet_8c_source.html#l00032">allocateSlaterDet()</a>, <a class="el" href="SlaterDet_8c_source.html#l00405">allocateSlaterDetAux()</a>, <a class="el" href="MinimizerDONLP2multivappcm_8c_source.html#l00108">angpara</a>, <a class="el" href="Symmetry_8h_source.html#l00020">axial</a>, <a class="el" href="Communication_8c_source.html#l00045">BroadcastSlaterDet()</a>, <a class="el" href="Communication_8c_source.html#l00038">BroadcastTask()</a>, <a class="el" href="SlaterDet_8c_source.html#l00468">calcSlaterDetAuxod()</a>, <a class="el" href="Projection_8h_source.html#l00115">ManyBodyOperator::dim</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00122">dim</a>, <a class="el" href="angprojection_8c_source.html#l00077">freeAngintegration()</a>, <a class="el" href="cmprojection_8c_source.html#l00298">freecmintegration()</a>, <a class="el" href="MultiSlaterDet_8h_source.html#l00042">_MSD_::get</a>, <a class="el" href="angprojection_8c_source.html#l00250">getangintegrationpoint()</a>, <a class="el" href="cmprojection_8c_source.html#l00305">getcmintegrationpoint()</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00102">j</a>, <a class="el" href="Projection_8h_source.html#l00093">Projection::jmax</a>, <a class="el" href="MinimizerDONLP2orthogonalproj_8c_source.html#l00098">k</a>, <a class="el" href="HOBasis_8c_source.html#l00050">l</a>, <a class="el" href="ProjectionMultimpi_8c_source.html#l00034">MAX</a>, <a class="el" href="Communication_8c_source.html#l00029">mpisize</a>, <a class="el" href="Projection_8h_source.html#l00083">angintegrationpara::n</a>, <a class="el" href="Projection_8h_source.html#l00041">cmintegrationpara::n</a>, <a class="el" href="MultiSlaterDet_8h_source.html#l00038">_MSD_::N</a>, <a class="el" href="MultiSlaterDet_8h_source.html#l00039">_MSD_::n</a>, <a class="el" href="Projection_8h_source.html#l00112">ManyBodyOperator::name</a>, <a class="el" href="MinimizerDONLP2vappcm_8c_source.html#l00104">ncm</a>, <a class="el" href="Projection_8h_source.html#l00094">Projection::odd</a>, <a class="el" href="SlaterDet_8h_source.html#l00047">SlaterDetAux::ovlap</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00108">projpar</a>, <a class="el" href="MinimizerDONLP2_8c_source.html#l00076">Q</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00130">Qp</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00131">Qpp</a>, <a class="el" href="Projection_8h_source.html#l00113">ManyBodyOperator::rank</a>, <a class="el" href="Projection_8h_source.html#l00116">ManyBodyOperator::size</a>, <a class="el" href="calcbasisovlapmulti_8c_source.html#l00032">SQR</a>, <a class="el" href="MultiSlaterDet_8h_source.html#l00040">_MSD_::symmetry</a>, <a class="el" href="Symmetry_8c_source.html#l00019">SymmetryAllowed()</a>, <a class="el" href="Symmetry_8c_source.html#l00076">SymmetrytoStr()</a>, <a class="el" href="Communication_8h_source.html#l00055">TAGMEOD</a>, <a class="el" href="Communication_8h_source.html#l00040">TAGPROJECT6</a>, <a class="el" href="donlp2_8h_source.html#l00057">val</a>, <a class="el" href="MultiSlaterDet_8h_source.html#l00041">_MSD_::weight</a>, and <a class="el" href="MinimizerDONLP2_8c_source.html#l00077">X</a>.</p>

<p>Referenced by <a class="el" href="calcenergymultiprojmulti_8c_source.html#l00052">main()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="comment">// only implemented for Observablesod by now</span>

  <span class="keywordtype">int</span> task;
  <span class="keywordflow">if</span> (!strncmp(Op-&gt;<a class="code" href="structManyBodyOperator.html#a4262723cd836949c28d7b922bc7178cd" title="uniquely identify operator including parameters">name</a>, <span class="stringliteral">&quot;Observables-&quot;</span>, 12)) {
    task = TASKPROJECTOBSERVABLESOD;
  } <span class="keywordflow">else</span> {
    fprintf(stderr, <span class="stringliteral">&quot;No parallelized implementation for this Operator yet !\n&quot;</span>);
    exit(127);
  }

  <span class="keywordtype">int</span> size=Op-&gt;<a class="code" href="structManyBodyOperator.html#a5597272550b373aa2136125a67e5d080" title="might be bigger than dimension">size</a>;
  <span class="keywordtype">int</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#ad5bd801f521717ed9f092360c3ba3b5e">dim</a>=Op-&gt;<a class="code" href="structManyBodyOperator.html#a9d2fc8f9d519079b19667ee3c96615db" title="dimension of operator">dim</a>;
  <span class="keywordtype">int</span> rank=Op-&gt;<a class="code" href="structManyBodyOperator.html#a2839a5170dccc5c19a75a414cccc710f" title="tensor rank of operator, 0 scalar, 2 vector, ...">rank</a>;
  complex double (***<a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a>)[(rank+1)*size] = mbme;

  <span class="keywordtype">int</span> jmax = P-&gt;<a class="code" href="structProjection.html#aaab8cf237ff5e23d0f7abb05117387fe" title="calculate up to (jmax-1)/2">jmax</a>;
  <span class="keywordtype">int</span> odd = P-&gt;<a class="code" href="structProjection.html#acac5e7c756632311adca04f228e8886e" title="odd particle number - half integer spin">odd</a>;

  <span class="comment">// loop over the individual SlaterDets in the MultiSlaterDets</span>
  <span class="keywordtype">int</span> nA = MBA-&gt;<a class="code" href="struct__MSD__.html#a63d226f46025181c738b22cc68f5af0a" title="by n SlaterDets">n</a>; <span class="keywordtype">int</span> nB = MBB-&gt;<a class="code" href="struct__MSD__.html#a63d226f46025181c738b22cc68f5af0a" title="by n SlaterDets">n</a>;
  <span class="keywordtype">int</span> iA, iB;

  <span class="keywordtype">int</span> NA = MBA-&gt;<a class="code" href="struct__MSD__.html#ae6519de16dc5677c17380eb22cf3fbfd" title="describe N many-body states">N</a>; <span class="keywordtype">int</span> NB = MBB-&gt;<a class="code" href="struct__MSD__.html#ae6519de16dc5677c17380eb22cf3fbfd" title="describe N many-body states">N</a>;
  <span class="keywordtype">int</span> IA, IB;

  <a class="code" href="structSlaterDet.html" title="Slater Determinant.">SlaterDet</a> <a class="code" href="MinimizerDONLP2_8c.html#ac4f7151b4c1c951d242ff9f8856381a0">Q</a>, <a class="code" href="MinimizerDONLP2multivapp_8c.html#a302070733a377867b458d28f3146454f">Qp</a>, <a class="code" href="MinimizerDONLP2multivapp_8c.html#a9e0195b1777800e72b4f7af51f0c3945">Qpp</a>;
  <a class="code" href="SlaterDet_8c.html#a0fe6e8eefc302957926038529e37e7c9" title="allocate memory for SlaterDet">allocateSlaterDet</a>(&amp;Q, MBA-&gt;<a class="code" href="struct__MSD__.html#a999772a06b90565150e39f99d8429589" title="particle number">A</a>);
  <a class="code" href="SlaterDet_8c.html#a0fe6e8eefc302957926038529e37e7c9" title="allocate memory for SlaterDet">allocateSlaterDet</a>(&amp;Qp, MBB-&gt;<a class="code" href="struct__MSD__.html#a999772a06b90565150e39f99d8429589" title="particle number">A</a>);
  <a class="code" href="SlaterDet_8c.html#a0fe6e8eefc302957926038529e37e7c9" title="allocate memory for SlaterDet">allocateSlaterDet</a>(&amp;Qpp, MBB-&gt;<a class="code" href="struct__MSD__.html#a999772a06b90565150e39f99d8429589" title="particle number">A</a>);

  <a class="code" href="structSlaterDetAux.html">SlaterDetAux</a> <a class="code" href="MinimizerDONLP2_8c.html#a40641ce31f478e07b357ff308ee3e47f">X</a>;
  <a class="code" href="SlaterDet_8c.html#a6489b81747a0bf6bab1e09d136f45065" title="allocate memory for SlaterDetAux">allocateSlaterDetAux</a>(&amp;X, <a class="code" href="ProjectionMultimpi_8c.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(MBA-&gt;<a class="code" href="struct__MSD__.html#a999772a06b90565150e39f99d8429589" title="particle number">A</a>, MBB-&gt;<a class="code" href="struct__MSD__.html#a999772a06b90565150e39f99d8429589" title="particle number">A</a>));

  <a class="code" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> S, Sp;
  <span class="keywordtype">int</span> axialsym;

  <span class="keywordtype">int</span> <a class="code" href="HOBasis_8c.html#a89606eca6b563ec68d2da2e84657736f">l</a>, r;
  <span class="keywordtype">int</span> p, <a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>, <a class="code" href="HOBasis_8c.html#a742204794ea328ba293fe59cec79b990">m</a>, <a class="code" href="MinimizerDONLP2orthogonalproj_8c.html#ab66ed8e0098c0a86b458672a55a9cca9">k</a>;


  <span class="comment">// set matrix elements to zero</span>
  <span class="keywordflow">for</span> (IB=0; IB&lt;NB; IB++)
    <span class="keywordflow">for</span> (IA=0; IA&lt;NA; IA++)
      <span class="keywordflow">for</span> (p=0; p&lt;=1; p++)
        <span class="keywordflow">for</span> (j=odd; j&lt;jmax; j=j+2) {
          <span class="keywordflow">for</span> (k=-j; k&lt;=j; k=k+2)
            <span class="keywordflow">for</span> (m=-j; m&lt;=j; m=m+2)
              <span class="keywordflow">for</span> (l=0; l&lt;dim; l++)
                <span class="keywordflow">for</span> (r=0; r&lt;=rank; r++)
                  <a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a>[IA+IB*NA][idxpij(jmax,p,j)][idxjmk(j,m,k)][r+l*(rank+1)] = 0.0;
        }                       


  <span class="comment">// we need a common denominaotor for the NA*NB matrix elements</span>
  <span class="comment">// all states have axial symmetry ? use axial as indicator</span>
  <span class="comment">// also spherical will be tretated like axial</span>

  S=0;
  axialsym=1;
  <span class="keywordflow">for</span> (IA=0; IA&lt;NA; IA++)
    axialsym &amp;= hasAxialSymmetry(MBA-&gt;<a class="code" href="struct__MSD__.html#a34f5b97aa2ded110084030cb5128620f" title="Symmetry.">symmetry</a>(MBA, IA));
  <span class="keywordflow">if</span> (axialsym)
    setSymmetry(&amp;S, <a class="code" href="Symmetry_8h.html#ab48899087cc647f0f791ed0c459adc53ab22f0ff9db3be11856d1b582fd09f474">axial</a>);

  Sp=0;
  axialsym=1;
  <span class="keywordflow">for</span> (IB=0; IB&lt;NB; IB++)
    axialsym &amp;= hasAxialSymmetry(MBB-&gt;<a class="code" href="struct__MSD__.html#a34f5b97aa2ded110084030cb5128620f" title="Symmetry.">symmetry</a>(MBB, IB));
  <span class="keywordflow">if</span> (axialsym)
    setSymmetry(&amp;Sp, <a class="code" href="Symmetry_8h.html#ab48899087cc647f0f791ed0c459adc53ab22f0ff9db3be11856d1b582fd09f474">axial</a>);

  fprintf(stderr, <span class="stringliteral">&quot;Symmetry - MBA: %s, MBB: %s\n&quot;</span>, <a class="code" href="Symmetry_8c.html#a57aa62a08fd12aa6fd7da2355ffb0ea0" title="get String with Symmetry">SymmetrytoStr</a>(S), <a class="code" href="Symmetry_8c.html#a57aa62a08fd12aa6fd7da2355ffb0ea0" title="get String with Symmetry">SymmetrytoStr</a>(Sp)); 

  <span class="keywordtype">double</span> kappaA[nA], kappaB[nB];
  <span class="keywordtype">double</span> acmA[nA], acmB[nB];
  
  <span class="keywordflow">for</span> (iA=0; iA&lt;nA; iA++) {
    MBA-&gt;<a class="code" href="struct__MSD__.html#a4f583db94740455d1e0853d1b95aa0a9" title="copy i-th SlaterDet into Q">get</a>(MBA, iA, &amp;Q);
    kappaA[iA] = <a class="code" href="angprojection_8c.html#a96407d07755537e4db8a7047f7a3549d">_estimateangkappa</a>(&amp;Q);
    acmA[iA] = <a class="code" href="cmprojection_8c.html#a48b0cf8e41bc07938e5a8260c308f742">_estimateacm</a>(&amp;Q);
  }

  <span class="keywordflow">for</span> (iB=0; iB&lt;nB; iB++) {
    MBB-&gt;<a class="code" href="struct__MSD__.html#a4f583db94740455d1e0853d1b95aa0a9" title="copy i-th SlaterDet into Q">get</a>(MBB, iB, &amp;Qp);
    kappaB[iB] = <a class="code" href="angprojection_8c.html#a96407d07755537e4db8a7047f7a3549d">_estimateangkappa</a>(&amp;Qp);
    acmB[iB] = <a class="code" href="cmprojection_8c.html#a48b0cf8e41bc07938e5a8260c308f742">_estimateacm</a>(&amp;Qp);
  }

  fprintf(stderr, <span class="stringliteral">&quot;kappacrit: %6.2f\n&quot;</span>, <a class="code" href="angprojection_8c.html#a58a9090fd80baea2ab54d2032e2531fd">_getangkappacrit</a>());
  fprintf(stderr, <span class="stringliteral">&quot;kappa - MBA: [%6.2f - %6.2f], MBB: [%6.2f - %6.2f]\n&quot;</span>,
          dminarray(kappaA, nA), dmaxarray(kappaA, nA),
          dminarray(kappaB, nB), dmaxarray(kappaB, nB));

  <span class="keywordtype">int</span> c=0; 
  <span class="keywordtype">int</span> cmax=nA*nB; 

  <span class="keywordflow">for</span> (iB=0; iB&lt;nB; iB++) {
    MBB-&gt;<a class="code" href="struct__MSD__.html#a4f583db94740455d1e0853d1b95aa0a9" title="copy i-th SlaterDet into Q">get</a>(MBB, iB, &amp;Qp);

    <span class="keywordflow">for</span> (iA=0; iA&lt;nA; iA++) {
      MBA-&gt;<a class="code" href="struct__MSD__.html#a4f583db94740455d1e0853d1b95aa0a9" title="copy i-th SlaterDet into Q">get</a>(MBA, iA, &amp;Q);

      <span class="comment">// progress indicator</span>
      c++;
      <span class="keywordflow">if</span> (c%100==0) fprintf(stderr, <span class="stringliteral">&quot;%d%%&quot;</span>, (100*c)/cmax);
      <span class="keywordflow">if</span> (c%10==0) fprintf(stderr, <span class="stringliteral">&quot;.&quot;</span>);

      <span class="comment">// norms of SlaterDets</span>
      <a class="code" href="SlaterDet_8c.html#ad3679a655d9b6019619456e5b7961638">calcSlaterDetAuxod</a>(&amp;Q, &amp;Q, &amp;X);
      <span class="keywordtype">double</span> norm = sqrt(creal(X.<a class="code" href="structSlaterDetAux.html#a19bee32579f8dd37e4834f06f07a231f" title="&amp;lt;Q|Q&amp;#39;&amp;gt;, only defined for non-diagonal">ovlap</a>));

      <a class="code" href="SlaterDet_8c.html#ad3679a655d9b6019619456e5b7961638">calcSlaterDetAuxod</a>(&amp;Qp, &amp;Qp, &amp;X);
      <span class="keywordtype">double</span> normp = sqrt(creal(X.<a class="code" href="structSlaterDetAux.html#a19bee32579f8dd37e4834f06f07a231f" title="&amp;lt;Q|Q&amp;#39;&amp;gt;, only defined for non-diagonal">ovlap</a>));  

      <span class="comment">// set up cm integration</span>
      <a class="code" href="structcmintegrationpara.html">cmintegrationpara</a> <a class="code" href="structcmpara.html">cmpara</a>;
      <span class="keywordtype">double</span> cmalpha = 0.5/(acmA[iA]+acmB[iB]);
      <a class="code" href="cmprojection_8c.html#afd49fd9499450859075a07b9c48230d3">_initcmintegration</a>(P, cmalpha, &amp;cmpara);
      <span class="keywordtype">int</span> <a class="code" href="MinimizerDONLP2vappcm_8c.html#a8a5e05e8fcc2b05354bff66fc1b1755c">ncm</a> = cmpara.<a class="code" href="structcmintegrationpara.html#ae1229cd214b908780ebc4ae9b66f5e19">n</a>;

      <span class="comment">// set up ang integration</span>
      <a class="code" href="structangintegrationpara.html">angintegrationpara</a> <a class="code" href="MinimizerDONLP2multivappcm_8c.html#a49105e626fcbcb1b768fedd076a84bd6">angpara</a>;
      <span class="keywordtype">double</span> angkappa = dmin(kappaA[iA], kappaB[iB]);
      <a class="code" href="angprojection_8c.html#a80b9d82dadcaadc0a6026004285b49f4">_initangintegration</a>(P, angkappa, S, Sp, &amp;angpara);
      <span class="keywordtype">int</span> nang = angpara.<a class="code" href="structangintegrationpara.html#a4b08f3ab8ebe1b43dc13c7e4223d3156">n</a>;

      <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);
      <a class="code" href="Communication_8c.html#a20a157ba304a85328b36c9727c72a578">BroadcastSlaterDet</a>(&amp;Q);
      <a class="code" href="Communication_8c.html#a20a157ba304a85328b36c9727c72a578">BroadcastSlaterDet</a>(&amp;Qp);

      <span class="comment">// loop over all the orientations</span>
      <span class="keywordtype">int</span> pi;

      <span class="keywordtype">int</span> todo = nang*ncm;
      <span class="keywordtype">int</span> running=0;
      <span class="keywordtype">int</span> done=0;
      <span class="keywordtype">int</span> processor;
      MPI_Status status;

      <span class="comment">// processor 0 is master</span>
      <span class="keywordtype">double</span> pos[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>][3];
      <span class="keywordtype">double</span> angle[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>][3];
      <span class="keywordtype">double</span> weight[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>];
      <span class="keywordtype">double</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#ae51b51057e3a9d5aa3905eed7979dca1">projpar</a>[6];
  
      <span class="comment">// which slaves are working, at beginning none</span>
      <span class="keywordtype">int</span> i;
      <span class="keywordtype">int</span> working[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>];
      <span class="keywordflow">for</span> (i=1; i&lt;<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>; i++)
        working[i] = 0;

      <span class="keywordtype">double</span> weightang, weightcm;
      complex <span class="keywordtype">double</span> sval[2][(rank+1)*size];

      <span class="keywordtype">int</span> next=0;
      <span class="keywordflow">while</span> (done&lt;todo) {

        <span class="keywordflow">if</span> (next&lt;todo &amp;&amp; running &lt; mpisize-1) { <span class="comment">// supply slaves with work</span>

          <span class="comment">// find empty slave</span>
          <span class="keywordflow">for</span> (i=1; i&lt;mpisize; i++)
            <span class="keywordflow">if</span> (!working[i]) {
              processor = i;
              <span class="keywordflow">break</span>;
            }

          <a class="code" href="cmprojection_8c.html#a4cde89930e46342aae042ab854f2290b">getcmintegrationpoint</a>(next/nang, &amp;cmpara, pos[processor], &amp;weightcm);
          <a class="code" href="angprojection_8c.html#a84c53149d9af0a652cb6486c9516cbb5">getangintegrationpoint</a>(next%nang, &amp;angpara, &amp;angle[processor][0], &amp;angle[processor][1], &amp;angle[processor][2], &amp;weightang); 

          weight[processor] = 1.0/(2*norm*normp)*weightcm*weightang;
      
          <span class="keywordflow">for</span> (i=0; i&lt;3; i++) projpar[i] = angle[processor][i];
          <span class="keywordflow">for</span> (i=0; i&lt;3; i++) projpar[i+3] = pos[processor][i];

          MPI_Send(projpar, 6, MPI_DOUBLE, processor, <a class="code" href="Communication_8h.html#a613b9e6e0268fd52fdac929ab05c67e4">TAGPROJECT6</a>, MPI_COMM_WORLD);

          working[processor] = 1;
          running++;
          next++;
        
        } <span class="keywordflow">else</span> {                                        <span class="comment">// collect results from slaves</span>

          MPI_Recv(sval, 2*(rank+1)*size, MPI_DOUBLE_COMPLEX, 
                   MPI_ANY_SOURCE, <a class="code" href="Communication_8h.html#ac684370c3174f484b6ec902a837ef0d0">TAGMEOD</a>, MPI_COMM_WORLD, &amp;status);
          processor = status.MPI_SOURCE;


          complex <span class="keywordtype">double</span> w, wA, wB;
          <a class="code" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> SA, SB;
          <span class="keywordflow">for</span> (IB=0; IB&lt;NB; IB++) {
            SB = MBB-&gt;<a class="code" href="struct__MSD__.html#a34f5b97aa2ded110084030cb5128620f" title="Symmetry.">symmetry</a>(MBB, IB);
            wB = MBB-&gt;<a class="code" href="struct__MSD__.html#af0a4a5e43b17ace83f6a2b6b51437dd0" title="weight of i-th SlaterDet in I-th many-body state">weight</a>(MBB, IB, iB);
            <span class="keywordflow">for</span> (IA=0; IA&lt;NA; IA++) {
              SA = MBA-&gt;<a class="code" href="struct__MSD__.html#a34f5b97aa2ded110084030cb5128620f" title="Symmetry.">symmetry</a>(MBA, IA);
              wA = MBA-&gt;<a class="code" href="struct__MSD__.html#af0a4a5e43b17ace83f6a2b6b51437dd0" title="weight of i-th SlaterDet in I-th many-body state">weight</a>(MBA, IA, iA);
              <span class="keywordflow">for</span> (pi=0; pi&lt;=1; pi++)
                <span class="keywordflow">for</span> (p=0; p&lt;=1; p++)
                  <span class="keywordflow">for</span> (j=odd; j&lt;jmax; j=j+2)
                    <span class="keywordflow">for</span> (k=-j; k&lt;=j; k=k+2)
                      <span class="keywordflow">for</span> (m=-j; m&lt;=j; m=m+2) {
                        <span class="keywordflow">if</span> ((Op-&gt;<a class="code" href="structManyBodyOperator.html#a2839a5170dccc5c19a75a414cccc710f" title="tensor rank of operator, 0 scalar, 2 vector, ...">rank</a> != 0 || <a class="code" href="Symmetry_8c.html#aec41b8bd88dceb2a0c5c3c4c4a8fefdb" title="quantum numbers J^pi,K allowed by symmetry ?">SymmetryAllowed</a>(SA, p, j, m)) &amp;&amp;
                            <a class="code" href="Symmetry_8c.html#aec41b8bd88dceb2a0c5c3c4c4a8fefdb" title="quantum numbers J^pi,K allowed by symmetry ?">SymmetryAllowed</a>(SB, p, j, k)) {
                          w = conj(wA)*wB*       
                            weight[processor] * (p &amp;&amp; pi%2 ? -1 : 1)*
                            (j+1)/(8*<a class="code" href="calcbasisovlapmulti_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">SQR</a>(M_PI))*Djmkstar(j,m,k,angle[processor][0],angle[processor][1],angle[processor][2]);
                          <span class="keywordflow">for</span> (l=0; l&lt;dim; l++)
                            <span class="keywordflow">for</span> (r=0; r&lt;=rank; r++)
                              <a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a>[IA+IB*NA][idxpij(jmax,p,j)][idxjmk(j,m,k)][r+l*(rank+1)] += w*sval[pi][r+l*(rank+1)];
                    }   
                  }
              }
            }

          working[processor] = 0;
          running--;
          done++;
        }
      }

      <span class="comment">// tell slaves we have finished</span>
      projpar[0] = -1.0;
      <span class="keywordflow">for</span> (processor=1; processor&lt;mpisize; processor++) {
        MPI_Send(projpar, 6, MPI_DOUBLE, processor, <a class="code" href="Communication_8h.html#a613b9e6e0268fd52fdac929ab05c67e4">TAGPROJECT6</a>, MPI_COMM_WORLD);
      }

      <a class="code" href="angprojection_8c.html#a5c0336acd3f2e1e48e88942a353129cd">freeAngintegration</a>(&amp;angpara);
      <a class="code" href="cmprojection_8c.html#a7ae9754fe9db92205d761777cfa5e336">freecmintegration</a>(&amp;cmpara);

    }
  }

}       
</pre></div></p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Dec 4 2012 14:05:36 for FMD by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
