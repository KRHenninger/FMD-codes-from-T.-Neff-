<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>FMD: fmdmpi/ProjectionMultimpi.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>fmdmpi/ProjectionMultimpi.c</h1>  </div>
</div>
<div class="contents">
<a href="ProjectionMultimpi_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;complex.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="SlaterDet_8h.html">fmd/SlaterDet.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="MultiSlaterDet_8h.html">fmd/MultiSlaterDet.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="Observables_8h.html">fmd/Observables.h</a>&quot;</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="wignerd_8h.html">numerics/wignerd.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="clebsch_8h.html">numerics/clebsch.h</a>&quot;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="physics_8h.html">misc/physics.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html">misc/utils.h</a>&quot;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="Communication_8h.html">Communication.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="Projectionmpi_8h.html">Projectionmpi.h</a>&quot;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="ProjectionMultimpi_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">00033</a> <span class="preprocessor">#define SQR(x) (x)*(x)</span>
<a name="l00034"></a><a class="code" href="ProjectionMultimpi_8c.html#aacc3ee1a7f283f8ef65cea31f4436a95">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX(x,y) ((x)&lt;(y) ? (y) : (x))</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">// parallelization only in the inner-loop for angular momentum integration</span>
<a name="l00038"></a>00038 <span class="comment">// this is not very efficient, especially if MultiSlaterDets have axial symmetry</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="comment">// todo: parallelize including outer loops </span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span> dmin(<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b)
<a name="l00043"></a>00043 {
<a name="l00044"></a>00044   <span class="keywordflow">return</span> (a &lt; b ? a : b);
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span> dmax(<span class="keywordtype">double</span> a, <span class="keywordtype">double</span> b)
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049   <span class="keywordflow">return</span> (a &gt; b ? a : b);
<a name="l00050"></a>00050 }
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="keyword">static</span> <span class="keywordtype">double</span> dminarray(<span class="keywordtype">double</span> a[], <span class="keywordtype">int</span> <a class="code" href="HOBasis_8c.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l00053"></a>00053 {
<a name="l00054"></a>00054   <span class="keywordtype">double</span> <a class="code" href="HOBasis_8c.html#a742204794ea328ba293fe59cec79b990">m</a> = a[0];
<a name="l00055"></a>00055   <span class="keywordtype">int</span> i;
<a name="l00056"></a>00056   <span class="keywordflow">for</span> (i=1; i&lt;n; i++)
<a name="l00057"></a>00057     m = dmin(m, a[i]);
<a name="l00058"></a>00058 
<a name="l00059"></a>00059   <span class="keywordflow">return</span> m;
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="keyword">static</span> <span class="keywordtype">double</span> dmaxarray(<span class="keywordtype">double</span> a[], <span class="keywordtype">int</span> n)
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064   <span class="keywordtype">double</span> m = a[0];
<a name="l00065"></a>00065   <span class="keywordtype">int</span> i;
<a name="l00066"></a>00066   <span class="keywordflow">for</span> (i=1; i&lt;n; i++)
<a name="l00067"></a>00067     m = dmax(m, a[i]);
<a name="l00068"></a>00068 
<a name="l00069"></a>00069   <span class="keywordflow">return</span> m;
<a name="l00070"></a>00070 }
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="ProjectionMultimpi_8h.html#a38c84ceb9bf621ef547baf4b214c5f87">00074</a> <span class="keywordtype">void</span> <a class="code" href="ProjectionMultimpi_8c.html#a38c84ceb9bf621ef547baf4b214c5f87">calcprojectedMultiMBMEmpi</a>(<span class="keyword">const</span> <a class="code" href="structProjection.html" title="Projection.">Projection</a>* <a class="code" href="MinimizerDONLP2_8c.html#a937218b25a684555a6d94a5058c7b358">P</a>, <span class="keyword">const</span> <a class="code" href="structManyBodyOperator.html" title="General ManyBody Operator.">ManyBodyOperator</a>* Op,
<a name="l00075"></a>00075                                <span class="keyword">const</span> <a class="code" href="struct__MSD__.html">MultiSlaterDet</a>* MBA, 
<a name="l00076"></a>00076                                <span class="keyword">const</span> <a class="code" href="struct__MSD__.html">MultiSlaterDet</a>* MBB,
<a name="l00077"></a>00077                                <span class="keywordtype">void</span>** mbme)
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079   <span class="comment">// only implemented for Observablesod by now</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081   <span class="keywordtype">int</span> task;
<a name="l00082"></a>00082   <span class="keywordflow">if</span> (!strncmp(Op-&gt;<a class="code" href="structManyBodyOperator.html#a4262723cd836949c28d7b922bc7178cd" title="uniquely identify operator including parameters">name</a>, <span class="stringliteral">&quot;Observables-&quot;</span>, 12)) {
<a name="l00083"></a>00083     task = TASKPROJECTOBSERVABLESOD;
<a name="l00084"></a>00084   } <span class="keywordflow">else</span> {
<a name="l00085"></a>00085     fprintf(stderr, <span class="stringliteral">&quot;No parallelized implementation for this Operator yet !\n&quot;</span>);
<a name="l00086"></a>00086     exit(127);
<a name="l00087"></a>00087   }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   <span class="keywordtype">int</span> size=Op-&gt;<a class="code" href="structManyBodyOperator.html#a5597272550b373aa2136125a67e5d080" title="might be bigger than dimension">size</a>;
<a name="l00090"></a>00090   <span class="keywordtype">int</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#ad5bd801f521717ed9f092360c3ba3b5e">dim</a>=Op-&gt;<a class="code" href="structManyBodyOperator.html#a9d2fc8f9d519079b19667ee3c96615db" title="dimension of operator">dim</a>;
<a name="l00091"></a>00091   <span class="keywordtype">int</span> rank=Op-&gt;<a class="code" href="structManyBodyOperator.html#a2839a5170dccc5c19a75a414cccc710f" title="tensor rank of operator, 0 scalar, 2 vector, ...">rank</a>;
<a name="l00092"></a>00092   complex double (***<a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a>)[(rank+1)*size] = mbme;
<a name="l00093"></a>00093 
<a name="l00094"></a>00094   <span class="keywordtype">int</span> jmax = P-&gt;<a class="code" href="structProjection.html#aaab8cf237ff5e23d0f7abb05117387fe" title="calculate up to (jmax-1)/2">jmax</a>;
<a name="l00095"></a>00095   <span class="keywordtype">int</span> odd = P-&gt;<a class="code" href="structProjection.html#acac5e7c756632311adca04f228e8886e" title="odd particle number - half integer spin">odd</a>;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097   <span class="comment">// loop over the individual SlaterDets in the MultiSlaterDets</span>
<a name="l00098"></a>00098   <span class="keywordtype">int</span> nA = MBA-&gt;<a class="code" href="struct__MSD__.html#a63d226f46025181c738b22cc68f5af0a" title="by n SlaterDets">n</a>; <span class="keywordtype">int</span> nB = MBB-&gt;<a class="code" href="struct__MSD__.html#a63d226f46025181c738b22cc68f5af0a" title="by n SlaterDets">n</a>;
<a name="l00099"></a>00099   <span class="keywordtype">int</span> iA, iB;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101   <span class="keywordtype">int</span> NA = MBA-&gt;<a class="code" href="struct__MSD__.html#ae6519de16dc5677c17380eb22cf3fbfd" title="describe N many-body states">N</a>; <span class="keywordtype">int</span> NB = MBB-&gt;<a class="code" href="struct__MSD__.html#ae6519de16dc5677c17380eb22cf3fbfd" title="describe N many-body states">N</a>;
<a name="l00102"></a>00102   <span class="keywordtype">int</span> IA, IB;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104   <a class="code" href="structSlaterDet.html" title="Slater Determinant.">SlaterDet</a> <a class="code" href="MinimizerDONLP2_8c.html#ac4f7151b4c1c951d242ff9f8856381a0">Q</a>, <a class="code" href="MinimizerDONLP2multivapp_8c.html#a302070733a377867b458d28f3146454f">Qp</a>, <a class="code" href="MinimizerDONLP2multivapp_8c.html#a9e0195b1777800e72b4f7af51f0c3945">Qpp</a>;
<a name="l00105"></a>00105   <a class="code" href="SlaterDet_8c.html#a0fe6e8eefc302957926038529e37e7c9" title="allocate memory for SlaterDet">allocateSlaterDet</a>(&amp;Q, MBA-&gt;<a class="code" href="struct__MSD__.html#a999772a06b90565150e39f99d8429589" title="particle number">A</a>);
<a name="l00106"></a>00106   <a class="code" href="SlaterDet_8c.html#a0fe6e8eefc302957926038529e37e7c9" title="allocate memory for SlaterDet">allocateSlaterDet</a>(&amp;Qp, MBB-&gt;<a class="code" href="struct__MSD__.html#a999772a06b90565150e39f99d8429589" title="particle number">A</a>);
<a name="l00107"></a>00107   <a class="code" href="SlaterDet_8c.html#a0fe6e8eefc302957926038529e37e7c9" title="allocate memory for SlaterDet">allocateSlaterDet</a>(&amp;Qpp, MBB-&gt;<a class="code" href="struct__MSD__.html#a999772a06b90565150e39f99d8429589" title="particle number">A</a>);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109   <a class="code" href="structSlaterDetAux.html">SlaterDetAux</a> <a class="code" href="MinimizerDONLP2_8c.html#a40641ce31f478e07b357ff308ee3e47f">X</a>;
<a name="l00110"></a>00110   <a class="code" href="SlaterDet_8c.html#a6489b81747a0bf6bab1e09d136f45065" title="allocate memory for SlaterDetAux">allocateSlaterDetAux</a>(&amp;X, <a class="code" href="ProjectionMultimpi_8c.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(MBA-&gt;<a class="code" href="struct__MSD__.html#a999772a06b90565150e39f99d8429589" title="particle number">A</a>, MBB-&gt;<a class="code" href="struct__MSD__.html#a999772a06b90565150e39f99d8429589" title="particle number">A</a>));
<a name="l00111"></a>00111 
<a name="l00112"></a>00112   <a class="code" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> S, Sp;
<a name="l00113"></a>00113   <span class="keywordtype">int</span> axialsym;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115   <span class="keywordtype">int</span> <a class="code" href="HOBasis_8c.html#a89606eca6b563ec68d2da2e84657736f">l</a>, r;
<a name="l00116"></a>00116   <span class="keywordtype">int</span> p, <a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>, m, <a class="code" href="MinimizerDONLP2orthogonalproj_8c.html#ab66ed8e0098c0a86b458672a55a9cca9">k</a>;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 
<a name="l00119"></a>00119   <span class="comment">// set matrix elements to zero</span>
<a name="l00120"></a>00120   <span class="keywordflow">for</span> (IB=0; IB&lt;NB; IB++)
<a name="l00121"></a>00121     <span class="keywordflow">for</span> (IA=0; IA&lt;NA; IA++)
<a name="l00122"></a>00122       <span class="keywordflow">for</span> (p=0; p&lt;=1; p++)
<a name="l00123"></a>00123         <span class="keywordflow">for</span> (j=odd; j&lt;jmax; j=j+2) {
<a name="l00124"></a>00124           <span class="keywordflow">for</span> (k=-j; k&lt;=j; k=k+2)
<a name="l00125"></a>00125             <span class="keywordflow">for</span> (m=-j; m&lt;=j; m=m+2)
<a name="l00126"></a>00126               <span class="keywordflow">for</span> (l=0; l&lt;dim; l++)
<a name="l00127"></a>00127                 <span class="keywordflow">for</span> (r=0; r&lt;=rank; r++)
<a name="l00128"></a>00128                   <a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a>[IA+IB*NA][idxpij(jmax,p,j)][idxjmk(j,m,k)][r+l*(rank+1)] = 0.0;
<a name="l00129"></a>00129         }                       
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 
<a name="l00132"></a>00132   <span class="comment">// we need a common denominaotor for the NA*NB matrix elements</span>
<a name="l00133"></a>00133   <span class="comment">// all states have axial symmetry ? use axial as indicator</span>
<a name="l00134"></a>00134   <span class="comment">// also spherical will be tretated like axial</span>
<a name="l00135"></a>00135 
<a name="l00136"></a>00136   S=0;
<a name="l00137"></a>00137   axialsym=1;
<a name="l00138"></a>00138   <span class="keywordflow">for</span> (IA=0; IA&lt;NA; IA++)
<a name="l00139"></a>00139     axialsym &amp;= hasAxialSymmetry(MBA-&gt;<a class="code" href="struct__MSD__.html#a34f5b97aa2ded110084030cb5128620f" title="Symmetry.">symmetry</a>(MBA, IA));
<a name="l00140"></a>00140   <span class="keywordflow">if</span> (axialsym)
<a name="l00141"></a>00141     setSymmetry(&amp;S, <a class="code" href="Symmetry_8h.html#ab48899087cc647f0f791ed0c459adc53ab22f0ff9db3be11856d1b582fd09f474">axial</a>);
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   Sp=0;
<a name="l00144"></a>00144   axialsym=1;
<a name="l00145"></a>00145   <span class="keywordflow">for</span> (IB=0; IB&lt;NB; IB++)
<a name="l00146"></a>00146     axialsym &amp;= hasAxialSymmetry(MBB-&gt;<a class="code" href="struct__MSD__.html#a34f5b97aa2ded110084030cb5128620f" title="Symmetry.">symmetry</a>(MBB, IB));
<a name="l00147"></a>00147   <span class="keywordflow">if</span> (axialsym)
<a name="l00148"></a>00148     setSymmetry(&amp;Sp, <a class="code" href="Symmetry_8h.html#ab48899087cc647f0f791ed0c459adc53ab22f0ff9db3be11856d1b582fd09f474">axial</a>);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   fprintf(stderr, <span class="stringliteral">&quot;Symmetry - MBA: %s, MBB: %s\n&quot;</span>, <a class="code" href="Symmetry_8c.html#a57aa62a08fd12aa6fd7da2355ffb0ea0" title="get String with Symmetry">SymmetrytoStr</a>(S), <a class="code" href="Symmetry_8c.html#a57aa62a08fd12aa6fd7da2355ffb0ea0" title="get String with Symmetry">SymmetrytoStr</a>(Sp)); 
<a name="l00151"></a>00151 
<a name="l00152"></a>00152   <span class="keywordtype">double</span> kappaA[nA], kappaB[nB];
<a name="l00153"></a>00153   <span class="keywordtype">double</span> acmA[nA], acmB[nB];
<a name="l00154"></a>00154   
<a name="l00155"></a>00155   <span class="keywordflow">for</span> (iA=0; iA&lt;nA; iA++) {
<a name="l00156"></a>00156     MBA-&gt;<a class="code" href="struct__MSD__.html#a4f583db94740455d1e0853d1b95aa0a9" title="copy i-th SlaterDet into Q">get</a>(MBA, iA, &amp;Q);
<a name="l00157"></a>00157     kappaA[iA] = <a class="code" href="angprojection_8c.html#a96407d07755537e4db8a7047f7a3549d">_estimateangkappa</a>(&amp;Q);
<a name="l00158"></a>00158     acmA[iA] = <a class="code" href="cmprojection_8c.html#a48b0cf8e41bc07938e5a8260c308f742">_estimateacm</a>(&amp;Q);
<a name="l00159"></a>00159   }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   <span class="keywordflow">for</span> (iB=0; iB&lt;nB; iB++) {
<a name="l00162"></a>00162     MBB-&gt;<a class="code" href="struct__MSD__.html#a4f583db94740455d1e0853d1b95aa0a9" title="copy i-th SlaterDet into Q">get</a>(MBB, iB, &amp;Qp);
<a name="l00163"></a>00163     kappaB[iB] = <a class="code" href="angprojection_8c.html#a96407d07755537e4db8a7047f7a3549d">_estimateangkappa</a>(&amp;Qp);
<a name="l00164"></a>00164     acmB[iB] = <a class="code" href="cmprojection_8c.html#a48b0cf8e41bc07938e5a8260c308f742">_estimateacm</a>(&amp;Qp);
<a name="l00165"></a>00165   }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167   fprintf(stderr, <span class="stringliteral">&quot;kappacrit: %6.2f\n&quot;</span>, <a class="code" href="angprojection_8c.html#a58a9090fd80baea2ab54d2032e2531fd">_getangkappacrit</a>());
<a name="l00168"></a>00168   fprintf(stderr, <span class="stringliteral">&quot;kappa - MBA: [%6.2f - %6.2f], MBB: [%6.2f - %6.2f]\n&quot;</span>,
<a name="l00169"></a>00169           dminarray(kappaA, nA), dmaxarray(kappaA, nA),
<a name="l00170"></a>00170           dminarray(kappaB, nB), dmaxarray(kappaB, nB));
<a name="l00171"></a>00171 
<a name="l00172"></a>00172   <span class="keywordtype">int</span> c=0; 
<a name="l00173"></a>00173   <span class="keywordtype">int</span> cmax=nA*nB; 
<a name="l00174"></a>00174 
<a name="l00175"></a>00175   <span class="keywordflow">for</span> (iB=0; iB&lt;nB; iB++) {
<a name="l00176"></a>00176     MBB-&gt;<a class="code" href="struct__MSD__.html#a4f583db94740455d1e0853d1b95aa0a9" title="copy i-th SlaterDet into Q">get</a>(MBB, iB, &amp;Qp);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <span class="keywordflow">for</span> (iA=0; iA&lt;nA; iA++) {
<a name="l00179"></a>00179       MBA-&gt;<a class="code" href="struct__MSD__.html#a4f583db94740455d1e0853d1b95aa0a9" title="copy i-th SlaterDet into Q">get</a>(MBA, iA, &amp;Q);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181       <span class="comment">// progress indicator</span>
<a name="l00182"></a>00182       c++;
<a name="l00183"></a>00183       <span class="keywordflow">if</span> (c%100==0) fprintf(stderr, <span class="stringliteral">&quot;%d%%&quot;</span>, (100*c)/cmax);
<a name="l00184"></a>00184       <span class="keywordflow">if</span> (c%10==0) fprintf(stderr, <span class="stringliteral">&quot;.&quot;</span>);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186       <span class="comment">// norms of SlaterDets</span>
<a name="l00187"></a>00187       <a class="code" href="SlaterDet_8c.html#ad3679a655d9b6019619456e5b7961638">calcSlaterDetAuxod</a>(&amp;Q, &amp;Q, &amp;X);
<a name="l00188"></a>00188       <span class="keywordtype">double</span> norm = sqrt(creal(X.<a class="code" href="structSlaterDetAux.html#a19bee32579f8dd37e4834f06f07a231f" title="&amp;lt;Q|Q&amp;#39;&amp;gt;, only defined for non-diagonal">ovlap</a>));
<a name="l00189"></a>00189 
<a name="l00190"></a>00190       <a class="code" href="SlaterDet_8c.html#ad3679a655d9b6019619456e5b7961638">calcSlaterDetAuxod</a>(&amp;Qp, &amp;Qp, &amp;X);
<a name="l00191"></a>00191       <span class="keywordtype">double</span> normp = sqrt(creal(X.<a class="code" href="structSlaterDetAux.html#a19bee32579f8dd37e4834f06f07a231f" title="&amp;lt;Q|Q&amp;#39;&amp;gt;, only defined for non-diagonal">ovlap</a>));  
<a name="l00192"></a>00192 
<a name="l00193"></a>00193       <span class="comment">// set up cm integration</span>
<a name="l00194"></a>00194       <a class="code" href="structcmintegrationpara.html">cmintegrationpara</a> <a class="code" href="structcmpara.html">cmpara</a>;
<a name="l00195"></a>00195       <span class="keywordtype">double</span> cmalpha = 0.5/(acmA[iA]+acmB[iB]);
<a name="l00196"></a>00196       <a class="code" href="cmprojection_8c.html#afd49fd9499450859075a07b9c48230d3">_initcmintegration</a>(P, cmalpha, &amp;cmpara);
<a name="l00197"></a>00197       <span class="keywordtype">int</span> <a class="code" href="MinimizerDONLP2vappcm_8c.html#a8a5e05e8fcc2b05354bff66fc1b1755c">ncm</a> = cmpara.<a class="code" href="structcmintegrationpara.html#ae1229cd214b908780ebc4ae9b66f5e19">n</a>;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199       <span class="comment">// set up ang integration</span>
<a name="l00200"></a>00200       <a class="code" href="structangintegrationpara.html">angintegrationpara</a> <a class="code" href="MinimizerDONLP2multivappcm_8c.html#a49105e626fcbcb1b768fedd076a84bd6">angpara</a>;
<a name="l00201"></a>00201       <span class="keywordtype">double</span> angkappa = dmin(kappaA[iA], kappaB[iB]);
<a name="l00202"></a>00202       <a class="code" href="angprojection_8c.html#a80b9d82dadcaadc0a6026004285b49f4">_initangintegration</a>(P, angkappa, S, Sp, &amp;angpara);
<a name="l00203"></a>00203       <span class="keywordtype">int</span> nang = angpara.<a class="code" href="structangintegrationpara.html#a4b08f3ab8ebe1b43dc13c7e4223d3156">n</a>;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205       <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);
<a name="l00206"></a>00206       <a class="code" href="Communication_8c.html#a20a157ba304a85328b36c9727c72a578">BroadcastSlaterDet</a>(&amp;Q);
<a name="l00207"></a>00207       <a class="code" href="Communication_8c.html#a20a157ba304a85328b36c9727c72a578">BroadcastSlaterDet</a>(&amp;Qp);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209       <span class="comment">// loop over all the orientations</span>
<a name="l00210"></a>00210       <span class="keywordtype">int</span> pi;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212       <span class="keywordtype">int</span> todo = nang*ncm;
<a name="l00213"></a>00213       <span class="keywordtype">int</span> running=0;
<a name="l00214"></a>00214       <span class="keywordtype">int</span> done=0;
<a name="l00215"></a>00215       <span class="keywordtype">int</span> processor;
<a name="l00216"></a>00216       MPI_Status status;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218       <span class="comment">// processor 0 is master</span>
<a name="l00219"></a>00219       <span class="keywordtype">double</span> pos[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>][3];
<a name="l00220"></a>00220       <span class="keywordtype">double</span> angle[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>][3];
<a name="l00221"></a>00221       <span class="keywordtype">double</span> weight[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>];
<a name="l00222"></a>00222       <span class="keywordtype">double</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#ae51b51057e3a9d5aa3905eed7979dca1">projpar</a>[6];
<a name="l00223"></a>00223   
<a name="l00224"></a>00224       <span class="comment">// which slaves are working, at beginning none</span>
<a name="l00225"></a>00225       <span class="keywordtype">int</span> i;
<a name="l00226"></a>00226       <span class="keywordtype">int</span> working[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>];
<a name="l00227"></a>00227       <span class="keywordflow">for</span> (i=1; i&lt;<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>; i++)
<a name="l00228"></a>00228         working[i] = 0;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230       <span class="keywordtype">double</span> weightang, weightcm;
<a name="l00231"></a>00231       complex <span class="keywordtype">double</span> sval[2][(rank+1)*size];
<a name="l00232"></a>00232 
<a name="l00233"></a>00233       <span class="keywordtype">int</span> next=0;
<a name="l00234"></a>00234       <span class="keywordflow">while</span> (done&lt;todo) {
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         <span class="keywordflow">if</span> (next&lt;todo &amp;&amp; running &lt; mpisize-1) { <span class="comment">// supply slaves with work</span>
<a name="l00237"></a>00237 
<a name="l00238"></a>00238           <span class="comment">// find empty slave</span>
<a name="l00239"></a>00239           <span class="keywordflow">for</span> (i=1; i&lt;mpisize; i++)
<a name="l00240"></a>00240             <span class="keywordflow">if</span> (!working[i]) {
<a name="l00241"></a>00241               processor = i;
<a name="l00242"></a>00242               <span class="keywordflow">break</span>;
<a name="l00243"></a>00243             }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245           <a class="code" href="cmprojection_8c.html#a4cde89930e46342aae042ab854f2290b">getcmintegrationpoint</a>(next/nang, &amp;cmpara, pos[processor], &amp;weightcm);
<a name="l00246"></a>00246           <a class="code" href="angprojection_8c.html#a84c53149d9af0a652cb6486c9516cbb5">getangintegrationpoint</a>(next%nang, &amp;angpara, &amp;angle[processor][0], &amp;angle[processor][1], &amp;angle[processor][2], &amp;weightang); 
<a name="l00247"></a>00247 
<a name="l00248"></a>00248           weight[processor] = 1.0/(2*norm*normp)*weightcm*weightang;
<a name="l00249"></a>00249       
<a name="l00250"></a>00250           <span class="keywordflow">for</span> (i=0; i&lt;3; i++) projpar[i] = angle[processor][i];
<a name="l00251"></a>00251           <span class="keywordflow">for</span> (i=0; i&lt;3; i++) projpar[i+3] = pos[processor][i];
<a name="l00252"></a>00252 
<a name="l00253"></a>00253           MPI_Send(projpar, 6, MPI_DOUBLE, processor, <a class="code" href="Communication_8h.html#a613b9e6e0268fd52fdac929ab05c67e4">TAGPROJECT6</a>, MPI_COMM_WORLD);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255           working[processor] = 1;
<a name="l00256"></a>00256           running++;
<a name="l00257"></a>00257           next++;
<a name="l00258"></a>00258         
<a name="l00259"></a>00259         } <span class="keywordflow">else</span> {                                        <span class="comment">// collect results from slaves</span>
<a name="l00260"></a>00260 
<a name="l00261"></a>00261           MPI_Recv(sval, 2*(rank+1)*size, MPI_DOUBLE_COMPLEX, 
<a name="l00262"></a>00262                    MPI_ANY_SOURCE, <a class="code" href="Communication_8h.html#ac684370c3174f484b6ec902a837ef0d0">TAGMEOD</a>, MPI_COMM_WORLD, &amp;status);
<a name="l00263"></a>00263           processor = status.MPI_SOURCE;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 
<a name="l00266"></a>00266           complex <span class="keywordtype">double</span> w, wA, wB;
<a name="l00267"></a>00267           <a class="code" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> SA, SB;
<a name="l00268"></a>00268           <span class="keywordflow">for</span> (IB=0; IB&lt;NB; IB++) {
<a name="l00269"></a>00269             SB = MBB-&gt;<a class="code" href="struct__MSD__.html#a34f5b97aa2ded110084030cb5128620f" title="Symmetry.">symmetry</a>(MBB, IB);
<a name="l00270"></a>00270             wB = MBB-&gt;<a class="code" href="struct__MSD__.html#af0a4a5e43b17ace83f6a2b6b51437dd0" title="weight of i-th SlaterDet in I-th many-body state">weight</a>(MBB, IB, iB);
<a name="l00271"></a>00271             <span class="keywordflow">for</span> (IA=0; IA&lt;NA; IA++) {
<a name="l00272"></a>00272               SA = MBA-&gt;<a class="code" href="struct__MSD__.html#a34f5b97aa2ded110084030cb5128620f" title="Symmetry.">symmetry</a>(MBA, IA);
<a name="l00273"></a>00273               wA = MBA-&gt;<a class="code" href="struct__MSD__.html#af0a4a5e43b17ace83f6a2b6b51437dd0" title="weight of i-th SlaterDet in I-th many-body state">weight</a>(MBA, IA, iA);
<a name="l00274"></a>00274               <span class="keywordflow">for</span> (pi=0; pi&lt;=1; pi++)
<a name="l00275"></a>00275                 <span class="keywordflow">for</span> (p=0; p&lt;=1; p++)
<a name="l00276"></a>00276                   <span class="keywordflow">for</span> (j=odd; j&lt;jmax; j=j+2)
<a name="l00277"></a>00277                     <span class="keywordflow">for</span> (k=-j; k&lt;=j; k=k+2)
<a name="l00278"></a>00278                       <span class="keywordflow">for</span> (m=-j; m&lt;=j; m=m+2) {
<a name="l00279"></a>00279                         <span class="keywordflow">if</span> ((Op-&gt;<a class="code" href="structManyBodyOperator.html#a2839a5170dccc5c19a75a414cccc710f" title="tensor rank of operator, 0 scalar, 2 vector, ...">rank</a> != 0 || <a class="code" href="Symmetry_8c.html#aec41b8bd88dceb2a0c5c3c4c4a8fefdb" title="quantum numbers J^pi,K allowed by symmetry ?">SymmetryAllowed</a>(SA, p, j, m)) &amp;&amp;
<a name="l00280"></a>00280                             <a class="code" href="Symmetry_8c.html#aec41b8bd88dceb2a0c5c3c4c4a8fefdb" title="quantum numbers J^pi,K allowed by symmetry ?">SymmetryAllowed</a>(SB, p, j, k)) {
<a name="l00281"></a>00281                           w = conj(wA)*wB*       
<a name="l00282"></a>00282                             weight[processor] * (p &amp;&amp; pi%2 ? -1 : 1)*
<a name="l00283"></a>00283                             (j+1)/(8*<a class="code" href="calcbasisovlapmulti_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">SQR</a>(M_PI))*Djmkstar(j,m,k,angle[processor][0],angle[processor][1],angle[processor][2]);
<a name="l00284"></a>00284                           <span class="keywordflow">for</span> (l=0; l&lt;dim; l++)
<a name="l00285"></a>00285                             <span class="keywordflow">for</span> (r=0; r&lt;=rank; r++)
<a name="l00286"></a>00286                               <a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a>[IA+IB*NA][idxpij(jmax,p,j)][idxjmk(j,m,k)][r+l*(rank+1)] += w*sval[pi][r+l*(rank+1)];
<a name="l00287"></a>00287                     }   
<a name="l00288"></a>00288                   }
<a name="l00289"></a>00289               }
<a name="l00290"></a>00290             }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292           working[processor] = 0;
<a name="l00293"></a>00293           running--;
<a name="l00294"></a>00294           done++;
<a name="l00295"></a>00295         }
<a name="l00296"></a>00296       }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298       <span class="comment">// tell slaves we have finished</span>
<a name="l00299"></a>00299       projpar[0] = -1.0;
<a name="l00300"></a>00300       <span class="keywordflow">for</span> (processor=1; processor&lt;mpisize; processor++) {
<a name="l00301"></a>00301         MPI_Send(projpar, 6, MPI_DOUBLE, processor, <a class="code" href="Communication_8h.html#a613b9e6e0268fd52fdac929ab05c67e4">TAGPROJECT6</a>, MPI_COMM_WORLD);
<a name="l00302"></a>00302       }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304       <a class="code" href="angprojection_8c.html#a5c0336acd3f2e1e48e88942a353129cd">freeAngintegration</a>(&amp;angpara);
<a name="l00305"></a>00305       <a class="code" href="cmprojection_8c.html#a7ae9754fe9db92205d761777cfa5e336">freecmintegration</a>(&amp;cmpara);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     }
<a name="l00308"></a>00308   }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 }       
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Dec 4 2012 14:05:34 for FMD by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
