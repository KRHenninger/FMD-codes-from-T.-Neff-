<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>FMD: fmdmpi/Projectionmpi.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<h1>fmdmpi/Projectionmpi.h File Reference</h1>  </div>
</div>
<div class="contents">
<code>#include &quot;<a class="el" href="SlaterDet_8h_source.html">fmd/SlaterDet.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="Projection_8h_source.html">fmd/Projection.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="Symmetry_8h_source.html">fmd/Symmetry.h</a>&quot;</code><br/>

<p><a href="Projectionmpi_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="Projectionmpi_8h.html#a3974ccaf7a9568d401f16c2c9655d955">calcprojectedMBMEmpi</a> (const <a class="el" href="structProjection.html">Projection</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#a937218b25a684555a6d94a5058c7b358">P</a>, const <a class="el" href="structManyBodyOperator.html">ManyBodyOperator</a> *Op, const <a class="el" href="structSlaterDet.html">SlaterDet</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#ac4f7151b4c1c951d242ff9f8856381a0">Q</a>, const <a class="el" href="structSlaterDet.html">SlaterDet</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#a302070733a377867b458d28f3146454f">Qp</a>, <a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> S, <a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> Sp, void *mbme)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="Projectionmpi_8h.html#a2fc17732e6cb492a846300fe897f6707">calcprojectedMBMEsmpi</a> (const <a class="el" href="structProjection.html">Projection</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#a937218b25a684555a6d94a5058c7b358">P</a>, const <a class="el" href="structManyBodyOperators.html">ManyBodyOperators</a> *Ops, const <a class="el" href="structSlaterDet.html">SlaterDet</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#ac4f7151b4c1c951d242ff9f8856381a0">Q</a>, const <a class="el" href="structSlaterDet.html">SlaterDet</a> *<a class="el" href="MinimizerDONLP2vappiso_8c.html#a302070733a377867b458d28f3146454f">Qp</a>, <a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> S, <a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a> Sp, void *mbme)</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>angular momentum projection of matrix elements MPI version</p>
<p>(c) 2003, 2004, 2005 Thomas Neff </p>

<p>Definition in file <a class="el" href="Projectionmpi_8h_source.html">Projectionmpi.h</a>.</p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a3974ccaf7a9568d401f16c2c9655d955"></a><!-- doxytag: member="Projectionmpi.h::calcprojectedMBMEmpi" ref="a3974ccaf7a9568d401f16c2c9655d955" args="(const Projection *P, const ManyBodyOperator *Op, const SlaterDet *Q, const SlaterDet *Qp, Symmetry S, Symmetry Sp, void *mbme)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calcprojectedMBMEmpi </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structProjection.html">Projection</a> *&nbsp;</td>
          <td class="paramname"> <em>P</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structManyBodyOperator.html">ManyBodyOperator</a> *&nbsp;</td>
          <td class="paramname"> <em>Op</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structSlaterDet.html">SlaterDet</a> *&nbsp;</td>
          <td class="paramname"> <em>Q</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structSlaterDet.html">SlaterDet</a> *&nbsp;</td>
          <td class="paramname"> <em>Qp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a>&nbsp;</td>
          <td class="paramname"> <em>S</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a>&nbsp;</td>
          <td class="paramname"> <em>Sp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>mbme</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Projectionmpi_8c_source.html#l00037">37</a> of file <a class="el" href="Projectionmpi_8c_source.html">Projectionmpi.c</a>.</p>

<p>References <a class="el" href="MinimizerDONLP2multivappcm_8c_source.html#l00108">angpara</a>, <a class="el" href="Communication_8c_source.html#l00045">BroadcastSlaterDet()</a>, <a class="el" href="Communication_8c_source.html#l00038">BroadcastTask()</a>, <a class="el" href="SlaterDet_8c_source.html#l00468">calcSlaterDetAuxod()</a>, <a class="el" href="Projection_8h_source.html#l00115">ManyBodyOperator::dim</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00122">dim</a>, <a class="el" href="angprojection_8c_source.html#l00250">getangintegrationpoint()</a>, <a class="el" href="cmprojection_8c_source.html#l00305">getcmintegrationpoint()</a>, <a class="el" href="angprojection_8c_source.html#l00210">initangintegration()</a>, <a class="el" href="cmprojection_8c_source.html#l00224">initcmintegration()</a>, <a class="el" href="SlaterDet_8c_source.html#l00414">initSlaterDetAux()</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00102">j</a>, <a class="el" href="Projection_8h_source.html#l00093">Projection::jmax</a>, <a class="el" href="MinimizerDONLP2orthogonalproj_8c_source.html#l00098">k</a>, <a class="el" href="HOBasis_8c_source.html#l00050">l</a>, <a class="el" href="HOBasis_8c_source.html#l00051">m</a>, <a class="el" href="Communication_8c_source.html#l00029">mpisize</a>, <a class="el" href="Projection_8h_source.html#l00083">angintegrationpara::n</a>, <a class="el" href="Projection_8h_source.html#l00041">cmintegrationpara::n</a>, <a class="el" href="Projection_8h_source.html#l00112">ManyBodyOperator::name</a>, <a class="el" href="MinimizerDONLP2vappcm_8c_source.html#l00104">ncm</a>, <a class="el" href="Projection_8h_source.html#l00094">Projection::odd</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00108">projpar</a>, <a class="el" href="Projection_8h_source.html#l00113">ManyBodyOperator::rank</a>, <a class="el" href="Projection_8h_source.html#l00116">ManyBodyOperator::size</a>, <a class="el" href="calcbasisovlapmulti_8c_source.html#l00032">SQR</a>, <a class="el" href="Symmetry_8c_source.html#l00019">SymmetryAllowed()</a>, <a class="el" href="Communication_8h_source.html#l00055">TAGMEOD</a>, <a class="el" href="Communication_8h_source.html#l00040">TAGPROJECT6</a>, <a class="el" href="donlp2_8h_source.html#l00057">val</a>, and <a class="el" href="MinimizerDONLP2_8c_source.html#l00077">X</a>.</p>

<p>Referenced by <a class="el" href="calcenergymultiproj_8c_source.html#l00052">main()</a>, and <a class="el" href="calcenergymultiprojsel_8c_source.html#l00290">readorcalcandwriteprojectedMBMEfromtoFile()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="comment">// only implemented for some operators</span>

  <span class="keywordflow">if</span> (!strncmp(Op-&gt;<a class="code" href="structManyBodyOperator.html#a4262723cd836949c28d7b922bc7178cd" title="uniquely identify operator including parameters">name</a>, <span class="stringliteral">&quot;Ovlap&quot;</span>, 5)) {
    <span class="keywordtype">int</span> task = TASKPROJECTOVLAPOD;
    <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);
  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(Op-&gt;<a class="code" href="structManyBodyOperator.html#a4262723cd836949c28d7b922bc7178cd" title="uniquely identify operator including parameters">name</a>, <span class="stringliteral">&quot;Observables-&quot;</span>, 12)) {
    <span class="keywordtype">int</span> task = TASKPROJECTOBSERVABLESOD;
    <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);
  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(Op-&gt;<a class="code" href="structManyBodyOperator.html#a4262723cd836949c28d7b922bc7178cd" title="uniquely identify operator including parameters">name</a>, <span class="stringliteral">&quot;EMonopoleFormfactor-&quot;</span>, 20)) {
    <span class="keywordtype">int</span> task = TASKPROJECTMONOPOLEFORMFACTOROD;
    <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);
  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(Op-&gt;<a class="code" href="structManyBodyOperator.html#a4262723cd836949c28d7b922bc7178cd" title="uniquely identify operator including parameters">name</a>, <span class="stringliteral">&quot;DiagonalDensityMatrixHO-&quot;</span>, 24)) {
    <span class="keywordtype">int</span> task = TASKPROJECTEDDIAGONALDENSITYMATRIXHOOD;
    <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);
  } <span class="keywordflow">else</span> {
    fprintf(stderr, <span class="stringliteral">&quot;No parallelized implementation for this Operator yet !\n&quot;</span>);
    exit(127);
  }

  <span class="keywordtype">int</span> size=Op-&gt;<a class="code" href="structManyBodyOperator.html#a5597272550b373aa2136125a67e5d080" title="might be bigger than dimension">size</a>;
  <span class="keywordtype">int</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#ad5bd801f521717ed9f092360c3ba3b5e">dim</a>=Op-&gt;<a class="code" href="structManyBodyOperator.html#a9d2fc8f9d519079b19667ee3c96615db" title="dimension of operator">dim</a>;
  <span class="keywordtype">int</span> rank=Op-&gt;<a class="code" href="structManyBodyOperator.html#a2839a5170dccc5c19a75a414cccc710f" title="tensor rank of operator, 0 scalar, 2 vector, ...">rank</a>;
  complex double (**<a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a>)[(rank+1)*size] = mbme;

  <a class="code" href="structSlaterDetAux.html">SlaterDetAux</a>  <a class="code" href="MinimizerDONLP2_8c.html#a40641ce31f478e07b357ff308ee3e47f">X</a>;

  <span class="keywordtype">int</span> jmax = P-&gt;<a class="code" href="structProjection.html#aaab8cf237ff5e23d0f7abb05117387fe" title="calculate up to (jmax-1)/2">jmax</a>;
  <span class="keywordtype">int</span> odd = P-&gt;<a class="code" href="structProjection.html#acac5e7c756632311adca04f228e8886e" title="odd particle number - half integer spin">odd</a>;

  <span class="comment">// norms of SlaterDets</span>
  <a class="code" href="SlaterDet_8c.html#a9d28b849a027b454fd2eddb812a884c5" title="init SlaterDetAux X">initSlaterDetAux</a>(Q, &amp;X);
  <a class="code" href="SlaterDet_8c.html#ad3679a655d9b6019619456e5b7961638">calcSlaterDetAuxod</a>(Q, Q, &amp;X);
  <span class="keywordtype">double</span> norm = sqrt(creal(X.ovlap));
  
  <a class="code" href="SlaterDet_8c.html#a9d28b849a027b454fd2eddb812a884c5" title="init SlaterDetAux X">initSlaterDetAux</a>(Qp, &amp;X);
  <a class="code" href="SlaterDet_8c.html#ad3679a655d9b6019619456e5b7961638">calcSlaterDetAuxod</a>(Qp, Qp, &amp;X);
  <span class="keywordtype">double</span> normp = sqrt(creal(X.ovlap));  

  <span class="comment">// set up cm integration</span>
  <a class="code" href="structcmintegrationpara.html">cmintegrationpara</a> <a class="code" href="structcmpara.html">cmpara</a>;
  <a class="code" href="cmprojection_8c.html#abf4911adb463930dc540277d1da25c35">initcmintegration</a>(P, Q, Qp, &amp;cmpara);
  <span class="keywordtype">int</span> <a class="code" href="MinimizerDONLP2vappcm_8c.html#a8a5e05e8fcc2b05354bff66fc1b1755c">ncm</a> = cmpara.<a class="code" href="structcmintegrationpara.html#ae1229cd214b908780ebc4ae9b66f5e19">n</a>;

  <span class="comment">// set up angular momentum integration</span>
  <a class="code" href="structangintegrationpara.html">angintegrationpara</a> <a class="code" href="MinimizerDONLP2multivappcm_8c.html#a49105e626fcbcb1b768fedd076a84bd6">angpara</a>;
  <a class="code" href="angprojection_8c.html#ae7ea91fc189ad0a0487363668e0ffa89">initangintegration</a>(P, Q, Qp, S, Sp, &amp;angpara);
  <span class="keywordtype">int</span> nang = angpara.<a class="code" href="structangintegrationpara.html#a4b08f3ab8ebe1b43dc13c7e4223d3156">n</a>;

  <span class="keywordtype">int</span> <a class="code" href="HOBasis_8c.html#a89606eca6b563ec68d2da2e84657736f">l</a>, r;
  <span class="keywordtype">int</span> p, <a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>, <a class="code" href="HOBasis_8c.html#a742204794ea328ba293fe59cec79b990">m</a>, <a class="code" href="MinimizerDONLP2orthogonalproj_8c.html#ab66ed8e0098c0a86b458672a55a9cca9">k</a>;

  <span class="comment">// set matrix elements to zero</span>
  <span class="keywordflow">for</span> (p=0; p&lt;=1; p++)
    <span class="keywordflow">for</span> (j=odd; j&lt;jmax; j=j+2) {
      <span class="keywordflow">for</span> (k=-j; k&lt;=j; k=k+2)
        <span class="keywordflow">for</span> (m=-j; m&lt;=j; m=m+2)
          <span class="keywordflow">for</span> (l=0; l&lt;dim; l++)
            <span class="keywordflow">for</span> (r=0; r&lt;=rank; r++)
              <a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a>[idxpij(jmax,p,j)][idxjmk(j,m,k)][r+l*(rank+1)] = 0.0;
    }   

  <a class="code" href="Communication_8c.html#a20a157ba304a85328b36c9727c72a578">BroadcastSlaterDet</a>(Q);
  <a class="code" href="Communication_8c.html#a20a157ba304a85328b36c9727c72a578">BroadcastSlaterDet</a>(Qp);

  <span class="comment">// loop over all the orientations</span>
  complex <span class="keywordtype">double</span> w;
  <span class="keywordtype">int</span> pi;

  <span class="keywordtype">int</span> todo = nang*ncm;
  <span class="keywordtype">int</span> running=0;
  <span class="keywordtype">int</span> done=0;
  <span class="keywordtype">int</span> processor;
  MPI_Status status;

  <span class="comment">// processor 0 is master</span>
  <span class="keywordtype">double</span> pos[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>][3];
  <span class="keywordtype">double</span> angle[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>][3];
  <span class="keywordtype">double</span> weight[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>];
  <span class="keywordtype">double</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#ae51b51057e3a9d5aa3905eed7979dca1">projpar</a>[6];
  
  <span class="comment">// which slaves are working, at beginning none</span>
  <span class="keywordtype">int</span> i;
  <span class="keywordtype">int</span> working[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>];
  <span class="keywordflow">for</span> (i=1; i&lt;<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>; i++)
    working[i] = 0;

  <span class="keywordtype">double</span> weightang, weightcm;
  complex <span class="keywordtype">double</span> sval[2][(rank+1)*size];

  <span class="keywordtype">int</span> next=0;
  <span class="keywordflow">while</span> (done&lt;todo) {

    <span class="keywordflow">if</span> (next&lt;todo &amp;&amp; running &lt; mpisize-1) {     <span class="comment">// supply slaves with work</span>

      <span class="comment">// find empty slave</span>
      <span class="keywordflow">for</span> (i=1; i&lt;mpisize; i++)
        <span class="keywordflow">if</span> (!working[i]) {
          processor = i;
          <span class="keywordflow">break</span>;
        }

      <a class="code" href="cmprojection_8c.html#a4cde89930e46342aae042ab854f2290b">getcmintegrationpoint</a>(next/nang, &amp;cmpara, pos[processor], &amp;weightcm);
      <a class="code" href="angprojection_8c.html#a84c53149d9af0a652cb6486c9516cbb5">getangintegrationpoint</a>(next%nang, &amp;angpara, &amp;angle[processor][0], &amp;angle[processor][1], &amp;angle[processor][2], &amp;weightang); 

      weight[processor] = 1.0/(2*norm*normp)*weightcm*weightang;
      
      <span class="keywordflow">for</span> (i=0; i&lt;3; i++) projpar[i] = angle[processor][i];
      <span class="keywordflow">for</span> (i=0; i&lt;3; i++) projpar[i+3] = pos[processor][i];

      MPI_Send(projpar, 6, MPI_DOUBLE, processor, <a class="code" href="Communication_8h.html#a613b9e6e0268fd52fdac929ab05c67e4">TAGPROJECT6</a>, MPI_COMM_WORLD);

      working[processor] = 1;
      running++;
      next++;
        
    } <span class="keywordflow">else</span> {                                    <span class="comment">// collect results from slaves</span>

      MPI_Recv(sval, 2*(rank+1)*size, MPI_DOUBLE_COMPLEX, 
               MPI_ANY_SOURCE, <a class="code" href="Communication_8h.html#ac684370c3174f484b6ec902a837ef0d0">TAGMEOD</a>, MPI_COMM_WORLD, &amp;status);
      processor = status.MPI_SOURCE;

      <span class="keywordflow">for</span> (pi=0; pi&lt;=1; pi++)
        <span class="keywordflow">for</span> (p=0; p&lt;=1; p++)
          <span class="keywordflow">for</span> (j=odd; j&lt;jmax; j=j+2)
            <span class="keywordflow">for</span> (k=-j; k&lt;=j; k=k+2)
              <span class="keywordflow">for</span> (m=-j; m&lt;=j; m=m+2) {
                <span class="keywordflow">if</span> ((Op-rank !=0 || <a class="code" href="Symmetry_8c.html#aec41b8bd88dceb2a0c5c3c4c4a8fefdb" title="quantum numbers J^pi,K allowed by symmetry ?">SymmetryAllowed</a>(S, p, j, m)) &amp;&amp;
                    <a class="code" href="Symmetry_8c.html#aec41b8bd88dceb2a0c5c3c4c4a8fefdb" title="quantum numbers J^pi,K allowed by symmetry ?">SymmetryAllowed</a>(Sp, p, j, k)) {
                  w = weight[processor] * (p &amp;&amp; pi%2 ? -1 : 1)*
                    (j+1)/(8*<a class="code" href="calcbasisovlapmulti_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">SQR</a>(M_PI))*Djmkstar(j,m,k,angle[processor][0],angle[processor][1],angle[processor][2]);
                  <span class="keywordflow">for</span> (l=0; l&lt;dim; l++)
                    <span class="keywordflow">for</span> (r=0; r&lt;=rank; r++)
                      <a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a>[idxpij(jmax,p,j)][idxjmk(j,m,k)][r+l*(rank+1)] += w*sval[pi][r+l*(rank+1)];
                }
              } 

      working[processor] = 0;
      running--;
      done++;
    }

  }

  <span class="comment">// tell slaves we have finished</span>
  projpar[0] = -1.0;
  <span class="keywordflow">for</span> (processor=1; processor&lt;mpisize; processor++) {
    MPI_Send(projpar, 6, MPI_DOUBLE, processor, <a class="code" href="Communication_8h.html#a613b9e6e0268fd52fdac929ab05c67e4">TAGPROJECT6</a>, MPI_COMM_WORLD);
  }

}       
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2fc17732e6cb492a846300fe897f6707"></a><!-- doxytag: member="Projectionmpi.h::calcprojectedMBMEsmpi" ref="a2fc17732e6cb492a846300fe897f6707" args="(const Projection *P, const ManyBodyOperators *Ops, const SlaterDet *Q, const SlaterDet *Qp, Symmetry S, Symmetry Sp, void *mbme)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calcprojectedMBMEsmpi </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structProjection.html">Projection</a> *&nbsp;</td>
          <td class="paramname"> <em>P</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structManyBodyOperators.html">ManyBodyOperators</a> *&nbsp;</td>
          <td class="paramname"> <em>Ops</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structSlaterDet.html">SlaterDet</a> *&nbsp;</td>
          <td class="paramname"> <em>Q</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="structSlaterDet.html">SlaterDet</a> *&nbsp;</td>
          <td class="paramname"> <em>Qp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a>&nbsp;</td>
          <td class="paramname"> <em>S</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="Symmetry_8h.html#abc0cfc197fb5dfb320dc8f2152faeb73">Symmetry</a>&nbsp;</td>
          <td class="paramname"> <em>Sp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>mbme</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="Projectionmpi_8c_source.html#l00194">194</a> of file <a class="el" href="Projectionmpi_8c_source.html">Projectionmpi.c</a>.</p>

<p>References <a class="el" href="MinimizerDONLP2multivappcm_8c_source.html#l00108">angpara</a>, <a class="el" href="Communication_8c_source.html#l00045">BroadcastSlaterDet()</a>, <a class="el" href="Communication_8c_source.html#l00038">BroadcastTask()</a>, <a class="el" href="SlaterDet_8c_source.html#l00468">calcSlaterDetAuxod()</a>, <a class="el" href="Projection_8h_source.html#l00130">ManyBodyOperators::dim</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00122">dim</a>, <a class="el" href="angprojection_8c_source.html#l00250">getangintegrationpoint()</a>, <a class="el" href="cmprojection_8c_source.html#l00305">getcmintegrationpoint()</a>, <a class="el" href="angprojection_8c_source.html#l00210">initangintegration()</a>, <a class="el" href="cmprojection_8c_source.html#l00224">initcmintegration()</a>, <a class="el" href="SlaterDet_8c_source.html#l00414">initSlaterDetAux()</a>, <a class="el" href="OneNucleonOvlaps_8c_source.html#l00041">io</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00102">j</a>, <a class="el" href="Projection_8h_source.html#l00093">Projection::jmax</a>, <a class="el" href="MinimizerDONLP2orthogonalproj_8c_source.html#l00098">k</a>, <a class="el" href="HOBasis_8c_source.html#l00050">l</a>, <a class="el" href="HOBasis_8c_source.html#l00051">m</a>, <a class="el" href="Communication_8c_source.html#l00029">mpisize</a>, <a class="el" href="Projection_8h_source.html#l00128">ManyBodyOperators::n</a>, <a class="el" href="Projection_8h_source.html#l00083">angintegrationpara::n</a>, <a class="el" href="Projection_8h_source.html#l00041">cmintegrationpara::n</a>, <a class="el" href="Projection_8h_source.html#l00127">ManyBodyOperators::name</a>, <a class="el" href="MinimizerDONLP2vappcm_8c_source.html#l00104">ncm</a>, <a class="el" href="Projection_8h_source.html#l00094">Projection::odd</a>, <a class="el" href="Projection_8h_source.html#l00132">ManyBodyOperators::Op</a>, <a class="el" href="SlaterDet_8h_source.html#l00047">SlaterDetAux::ovlap</a>, <a class="el" href="MinimizerDONLP2multivapp_8c_source.html#l00108">projpar</a>, <a class="el" href="Projection_8h_source.html#l00113">ManyBodyOperator::rank</a>, <a class="el" href="Projection_8h_source.html#l00131">ManyBodyOperators::size</a>, <a class="el" href="calcbasisovlapmulti_8c_source.html#l00032">SQR</a>, <a class="el" href="Symmetry_8c_source.html#l00019">SymmetryAllowed()</a>, <a class="el" href="Communication_8h_source.html#l00055">TAGMEOD</a>, <a class="el" href="Communication_8h_source.html#l00040">TAGPROJECT6</a>, <a class="el" href="donlp2_8h_source.html#l00057">val</a>, and <a class="el" href="MinimizerDONLP2_8c_source.html#l00077">X</a>.</p>

<p>Referenced by <a class="el" href="calconenucleonovlaps_8c_source.html#l00047">main()</a>.</p>

<p><div class="fragment"><pre class="fragment">{
  <span class="comment">// only implemented for some operators</span>

  <span class="keywordflow">if</span> (!strncmp(Ops-&gt;<a class="code" href="structManyBodyOperators.html#a331636b79824e209f31a9bfcac5bc026">name</a>, <span class="stringliteral">&quot;OneNucleonOvlaps-&quot;</span>, 17)) {
    <span class="keywordtype">int</span> task = TASKPROJECTONENUCLEONOVLAPSOD;
    <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);
  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(Ops-&gt;<a class="code" href="structManyBodyOperators.html#a331636b79824e209f31a9bfcac5bc026">name</a>, <span class="stringliteral">&quot;TwoNucleonOvlapsT-&quot;</span>, 18)) {
    <span class="keywordtype">int</span> task = TASKPROJECTTWONUCLEONOVLAPSTOD;
    <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);
  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(Ops-&gt;<a class="code" href="structManyBodyOperators.html#a331636b79824e209f31a9bfcac5bc026">name</a>, <span class="stringliteral">&quot;TwoNucleonOvlapsY-&quot;</span>, 18)) {
    <span class="keywordtype">int</span> task = TASKPROJECTTWONUCLEONOVLAPSYOD;
    <a class="code" href="Communication_8c.html#a74a3cac6e654a97021b6cdd00f51bebd">BroadcastTask</a>(&amp;task);
  } <span class="keywordflow">else</span> {
    fprintf(stderr, <span class="stringliteral">&quot;No parallelized implementation for this Operator yet !\n&quot;</span>);
    exit(127);
  }

  <span class="keywordtype">int</span> size=Ops-&gt;<a class="code" href="structManyBodyOperators.html#a94494657638d56cc4a332f00aefcd1e4">size</a>;
  <span class="keywordtype">int</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#ad5bd801f521717ed9f092360c3ba3b5e">dim</a>=Ops-&gt;<a class="code" href="structManyBodyOperators.html#aa1b09f1ea3ecfedd76ca27f7954ce65b" title="has to be the same for all Operators">dim</a>;
  complex <span class="keywordtype">double</span> ***<a class="code" href="donlp2_8h.html#a4826db9a70669b4ad6637f200d0dd976">val</a> = mbme;

  <a class="code" href="structSlaterDetAux.html">SlaterDetAux</a>  <a class="code" href="MinimizerDONLP2_8c.html#a40641ce31f478e07b357ff308ee3e47f">X</a>;

  <span class="keywordtype">int</span> jmax = P-&gt;<a class="code" href="structProjection.html#aaab8cf237ff5e23d0f7abb05117387fe" title="calculate up to (jmax-1)/2">jmax</a>;
  <span class="keywordtype">int</span> odd = P-&gt;<a class="code" href="structProjection.html#acac5e7c756632311adca04f228e8886e" title="odd particle number - half integer spin">odd</a>;

  <span class="comment">// norms of SlaterDets</span>
  <a class="code" href="SlaterDet_8c.html#a9d28b849a027b454fd2eddb812a884c5" title="init SlaterDetAux X">initSlaterDetAux</a>(Q, &amp;X);
  <a class="code" href="SlaterDet_8c.html#ad3679a655d9b6019619456e5b7961638">calcSlaterDetAuxod</a>(Q, Q, &amp;X);
  <span class="keywordtype">double</span> norm = sqrt(creal(X.<a class="code" href="structSlaterDetAux.html#a19bee32579f8dd37e4834f06f07a231f" title="&amp;lt;Q|Q&amp;#39;&amp;gt;, only defined for non-diagonal">ovlap</a>));
  
  <a class="code" href="SlaterDet_8c.html#a9d28b849a027b454fd2eddb812a884c5" title="init SlaterDetAux X">initSlaterDetAux</a>(Qp, &amp;X);
  <a class="code" href="SlaterDet_8c.html#ad3679a655d9b6019619456e5b7961638">calcSlaterDetAuxod</a>(Qp, Qp, &amp;X);
  <span class="keywordtype">double</span> normp = sqrt(creal(X.<a class="code" href="structSlaterDetAux.html#a19bee32579f8dd37e4834f06f07a231f" title="&amp;lt;Q|Q&amp;#39;&amp;gt;, only defined for non-diagonal">ovlap</a>));  

  <span class="comment">// set up cm integration</span>
  <a class="code" href="structcmintegrationpara.html">cmintegrationpara</a> <a class="code" href="structcmpara.html">cmpara</a>;
  <a class="code" href="cmprojection_8c.html#abf4911adb463930dc540277d1da25c35">initcmintegration</a>(P, Q, Qp, &amp;cmpara);
  <span class="keywordtype">int</span> <a class="code" href="MinimizerDONLP2vappcm_8c.html#a8a5e05e8fcc2b05354bff66fc1b1755c">ncm</a> = cmpara.<a class="code" href="structcmintegrationpara.html#ae1229cd214b908780ebc4ae9b66f5e19">n</a>;

  <span class="comment">// set up angular momentum integration</span>
  <a class="code" href="structangintegrationpara.html">angintegrationpara</a> <a class="code" href="MinimizerDONLP2multivappcm_8c.html#a49105e626fcbcb1b768fedd076a84bd6">angpara</a>;
  <a class="code" href="angprojection_8c.html#ae7ea91fc189ad0a0487363668e0ffa89">initangintegration</a>(P, Q, Qp, S, Sp, &amp;angpara);
  <span class="keywordtype">int</span> nang = angpara.<a class="code" href="structangintegrationpara.html#a4b08f3ab8ebe1b43dc13c7e4223d3156">n</a>;

  <span class="keywordtype">int</span> <a class="code" href="HOBasis_8c.html#a89606eca6b563ec68d2da2e84657736f">l</a>, r;
  <span class="keywordtype">int</span> o, p, <a class="code" href="MinimizerDONLP2multivapp_8c.html#a37d972ae0b47b9099e30983131d31916">j</a>, <a class="code" href="HOBasis_8c.html#a742204794ea328ba293fe59cec79b990">m</a>, <a class="code" href="MinimizerDONLP2orthogonalproj_8c.html#ab66ed8e0098c0a86b458672a55a9cca9">k</a>;

  <span class="comment">// helpful for indexing matrix elements</span>

  <span class="keywordtype">int</span> ranko[Ops-&gt;<a class="code" href="structManyBodyOperators.html#ab95444d93053e68e632c2ca2948b6177" title="number of operators">n</a>];
  <span class="keywordflow">for</span> (o=0; o&lt;Ops-&gt;<a class="code" href="structManyBodyOperators.html#ab95444d93053e68e632c2ca2948b6177" title="number of operators">n</a>; o++)
    ranko[o] = Ops-&gt;<a class="code" href="structManyBodyOperators.html#aec0b3262bd8c350633c8ba56cd09f16f">Op</a>[o].<a class="code" href="structManyBodyOperator.html#a2839a5170dccc5c19a75a414cccc710f" title="tensor rank of operator, 0 scalar, 2 vector, ...">rank</a>;

  <span class="keywordtype">int</span> sizeo[Ops-&gt;<a class="code" href="structManyBodyOperators.html#ab95444d93053e68e632c2ca2948b6177" title="number of operators">n</a>];
  for (o=0; o&lt;Ops-&gt;<a class="code" href="structManyBodyOperators.html#ab95444d93053e68e632c2ca2948b6177" title="number of operators">n</a>; o++)
    sizeo[o] = size*(ranko[o]+1);

  <span class="keywordtype">int</span> <a class="code" href="OneNucleonOvlaps_8c.html#a13396ab49d1309c7c94166be31333904">io</a>[Ops-&gt;<a class="code" href="structManyBodyOperators.html#ab95444d93053e68e632c2ca2948b6177" title="number of operators">n</a>]; io[0] = 0;
  <span class="keywordflow">for</span> (o=0; o&lt;Ops-&gt;<a class="code" href="structManyBodyOperators.html#ab95444d93053e68e632c2ca2948b6177" title="number of operators">n</a>-1; o++)
    io[o+1] = io[o]+sizeo[o];

  <span class="keywordtype">int</span> no=0;
  <span class="keywordflow">for</span> (o=0; o&lt;Ops-&gt;<a class="code" href="structManyBodyOperators.html#ab95444d93053e68e632c2ca2948b6177" title="number of operators">n</a>; o++)
    no += sizeo[o];


  <span class="comment">// set matrix elements to zero</span>
  <span class="keywordflow">for</span> (o=0; o&lt;Ops-&gt;<a class="code" href="structManyBodyOperators.html#ab95444d93053e68e632c2ca2948b6177" title="number of operators">n</a>; o++)
    <span class="keywordflow">for</span> (p=0; p&lt;=1; p++)
      <span class="keywordflow">for</span> (j=odd; j&lt;jmax; j=j+2) {
        <span class="keywordflow">for</span> (k=-j; k&lt;=j; k=k+2)
          <span class="keywordflow">for</span> (m=-j; m&lt;=j; m=m+2)
            <span class="keywordflow">for</span> (l=0; l&lt;dim; l++)
              <span class="keywordflow">for</span> (r=0; r&lt;=ranko[o]; r++)
                val[o][idxpij(jmax,p,j)][r+l*(ranko[o]+1)+idxjmk(j,m,k)*sizeo[o]] = 0.0;
    }   

  <a class="code" href="Communication_8c.html#a20a157ba304a85328b36c9727c72a578">BroadcastSlaterDet</a>(Q);
  <a class="code" href="Communication_8c.html#a20a157ba304a85328b36c9727c72a578">BroadcastSlaterDet</a>(Qp);

  <span class="comment">// loop over all the orientations</span>
  complex <span class="keywordtype">double</span> w;
  <span class="keywordtype">int</span> pi;

  <span class="keywordtype">int</span> todo = nang*ncm;
  <span class="keywordtype">int</span> running=0;
  <span class="keywordtype">int</span> done=0;
  <span class="keywordtype">int</span> processor;
  MPI_Status status;

  <span class="comment">// processor 0 is master</span>
  <span class="keywordtype">double</span> pos[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>][3];
  <span class="keywordtype">double</span> angle[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>][3];
  <span class="keywordtype">double</span> weight[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>];
  <span class="keywordtype">double</span> <a class="code" href="MinimizerDONLP2multivapp_8c.html#ae51b51057e3a9d5aa3905eed7979dca1">projpar</a>[6];
  
  <span class="comment">// which slaves are working, at beginning none</span>
  <span class="keywordtype">int</span> i;
  <span class="keywordtype">int</span> working[<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>];
  <span class="keywordflow">for</span> (i=1; i&lt;<a class="code" href="Communication_8c.html#a76bbfaa16fe885d266a99a79acdaee7e">mpisize</a>; i++)
    working[i] = 0;

  <span class="keywordtype">double</span> weightang, weightcm;
  complex <span class="keywordtype">double</span> sval[2][no];

  <span class="keywordtype">int</span> next=0;
  <span class="keywordflow">while</span> (done&lt;todo) {

    <span class="keywordflow">if</span> (next&lt;todo &amp;&amp; running &lt; mpisize-1) {     <span class="comment">// supply slaves with work</span>

      <span class="comment">// find empty slave</span>
      <span class="keywordflow">for</span> (i=1; i&lt;mpisize; i++)
        <span class="keywordflow">if</span> (!working[i]) {
          processor = i;
          <span class="keywordflow">break</span>;
        }

      <a class="code" href="cmprojection_8c.html#a4cde89930e46342aae042ab854f2290b">getcmintegrationpoint</a>(next/nang, &amp;cmpara, pos[processor], &amp;weightcm);
      <a class="code" href="angprojection_8c.html#a84c53149d9af0a652cb6486c9516cbb5">getangintegrationpoint</a>(next%nang, &amp;angpara, &amp;angle[processor][0], &amp;angle[processor][1], &amp;angle[processor][2], &amp;weightang); 

      weight[processor] = 1.0/(2*norm*normp)*weightcm*weightang;
      
      <span class="keywordflow">for</span> (i=0; i&lt;3; i++) projpar[i] = angle[processor][i];
      <span class="keywordflow">for</span> (i=0; i&lt;3; i++) projpar[i+3] = pos[processor][i];

      MPI_Send(projpar, 6, MPI_DOUBLE, processor, <a class="code" href="Communication_8h.html#a613b9e6e0268fd52fdac929ab05c67e4">TAGPROJECT6</a>, MPI_COMM_WORLD);

      working[processor] = 1;
      running++;
      next++;
        
    } <span class="keywordflow">else</span> {                                    <span class="comment">// collect results from slaves</span>

      MPI_Recv(sval, 2*no, MPI_DOUBLE_COMPLEX, 
               MPI_ANY_SOURCE, <a class="code" href="Communication_8h.html#ac684370c3174f484b6ec902a837ef0d0">TAGMEOD</a>, MPI_COMM_WORLD, &amp;status);
      processor = status.MPI_SOURCE;

      <span class="keywordflow">for</span> (pi=0; pi&lt;=1; pi++)
        <span class="keywordflow">for</span> (o=0; o&lt;Ops-&gt;<a class="code" href="structManyBodyOperators.html#ab95444d93053e68e632c2ca2948b6177" title="number of operators">n</a>; o++)
          <span class="keywordflow">for</span> (p=0; p&lt;=1; p++)
            <span class="keywordflow">for</span> (j=odd; j&lt;jmax; j=j+2)
              <span class="keywordflow">for</span> (k=-j; k&lt;=j; k=k+2)
                <span class="keywordflow">for</span> (m=-j; m&lt;=j; m=m+2) {
                  <span class="keywordflow">if</span> ((ranko[o] !=0 || <a class="code" href="Symmetry_8c.html#aec41b8bd88dceb2a0c5c3c4c4a8fefdb" title="quantum numbers J^pi,K allowed by symmetry ?">SymmetryAllowed</a>(S, p, j, m)) &amp;&amp;
                      <a class="code" href="Symmetry_8c.html#aec41b8bd88dceb2a0c5c3c4c4a8fefdb" title="quantum numbers J^pi,K allowed by symmetry ?">SymmetryAllowed</a>(Sp, p, j, k)) {
                    w = weight[processor] * (p &amp;&amp; pi%2 ? -1 : 1)*
                      (j+1)/(8*<a class="code" href="calcbasisovlapmulti_8c.html#aa7866fa5e4e0ee9b034e9dab6599a9cc">SQR</a>(M_PI))*Djmkstar(j,m,k,angle[processor][0],angle[processor][1],angle[processor][2]);
                    <span class="keywordflow">for</span> (l=0; l&lt;dim; l++)
                      <span class="keywordflow">for</span> (r=0; r&lt;=ranko[o]; r++)
                        val[o][idxpij(jmax,p,j)][r+l*(ranko[o]+1)+idxjmk(j,m,k)*sizeo[o]] += w*sval[pi][r+l*(ranko[o]+1)+io[o]];
                  }
                }       

      working[processor] = 0;
      running--;
      done++;
    }

  }

  <span class="comment">// tell slaves we have finished</span>
  projpar[0] = -1.0;
  <span class="keywordflow">for</span> (processor=1; processor&lt;mpisize; processor++) {
    MPI_Send(projpar, 6, MPI_DOUBLE, processor, <a class="code" href="Communication_8h.html#a613b9e6e0268fd52fdac929ab05c67e4">TAGPROJECT6</a>, MPI_COMM_WORLD);
  }

}       
</pre></div></p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Dec 4 2012 14:05:36 for FMD by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
