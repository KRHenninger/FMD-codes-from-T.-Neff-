/*-*-C-*-
 * Copyright (C) 1996--2001  Petter Urkedal (petter.urkedal@matfys.lth.se)
 *
 * This file is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This file is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 *
 * As a special exception, you may use this file as part of a free
 * software library without restriction.  Specifically, if other files
 * instantiate templates or use macros or inline functions from this
 * file, or you compile this file and link it with other files to
 * produce an executable, this file does not by itself cause the
 * resulting executable to be covered by the GNU General Public
 * License.  This exception does not however invalidate any other
 * reasons why the executable file might be covered by the GNU General
 * Public License.
 *
 * $Id: clebsch.c,v 1.1 2002/05/30 18:01:37 petter_urkedal Exp $
 */


/* Calculates the Clebsch-Gordan coefficients by Racha's closed
 * expression.
 */

#include <math.h>
#include <assert.h>

#include "clebsch.h"


#define MAX_FACTAB 100
#define c_pi_sqrt	1.77245385090551602729817

double tab_fac[100] = {
  1.00000000000000000000e+00,
  1.00000000000000000000e+00,
  2.00000000000000000000e+00,
  6.00000000000000000000e+00,
  2.40000000000000000000e+01,
  1.20000000000000000000e+02,
  7.20000000000000000000e+02,
  5.04000000000000000000e+03,
  4.03200000000000000000e+04,
  3.62880000000000000000e+05,
  3.62880000000000000000e+06,
  3.99168000000000000000e+07,
  4.79001600000000000000e+08,
  6.22702080000000000000e+09,
  8.71782912000000000000e+10,
  1.30767436800000000000e+12,
  2.09227898880000000000e+13,
  3.55687428096000000000e+14,
  6.40237370572800000000e+15,
  1.21645100408832000000e+17,
  2.43290200817664000000e+18,
  5.10909421717094400000e+19,
  1.12400072777760770000e+21,
  2.58520167388849780000e+22,
  6.20448401733239410000e+23,
  1.55112100433309860000e+25,
  4.03291461126605650000e+26,
  1.08888694504183520000e+28,
  3.04888344611713870000e+29,
  8.84176199373970190000e+30,
  2.65252859812191070000e+32,
  8.22283865417792240000e+33,
  2.63130836933693520000e+35,
  8.68331761881188590000e+36,
  2.95232799039604160000e+38,
  1.03331479663861450000e+40,
  3.71993326789901250000e+41,
  1.37637530912263460000e+43,
  5.23022617466601120000e+44,
  2.03978820811974440000e+46,
  8.15915283247897680000e+47,
  3.34525266131638080000e+49,
  1.40500611775288000000e+51,
  6.04152630633738340000e+52,
  2.65827157478844890000e+54,
  1.19622220865480190000e+56,
  5.50262215981208920000e+57,
  2.58623241511168180000e+59,
  1.24139155925360730000e+61,
  6.08281864034267520000e+62,
  3.04140932017133760000e+64,
  1.55111875328738220000e+66,
  8.06581751709438770000e+67,
  4.27488328406002550000e+69,
  2.30843697339241380000e+71,
  1.26964033536582760000e+73,
  7.10998587804863480000e+74,
  4.05269195048772140000e+76,
  2.35056133128287850000e+78,
  1.38683118545689840000e+80,
  8.32098711274138990000e+81,
  5.07580213877224840000e+83,
  3.14699732603879390000e+85,
  1.98260831540444010000e+87,
  1.26886932185884170000e+89,
  8.24765059208247150000e+90,
  5.44344939077443070000e+92,
  3.64711109181886830000e+94,
  2.48003554243683050000e+96,
  1.71122452428141300000e+98,
  1.19785716699698920000e+100,
  8.50478588567862300000e+101,
  6.12344583768860850000e+103,
  4.47011546151268440000e+105,
  3.30788544151938620000e+107,
  2.48091408113954000000e+109,
  1.88549470166605040000e+111,
  1.45183092028285870000e+113,
  1.13242811782062970000e+115,
  8.94618213078297570000e+116,
  7.15694570462638060000e+118,
  5.79712602074736780000e+120,
  4.75364333701284200000e+122,
  3.94552396972065880000e+124,
  3.31424013456535320000e+126,
  2.81710411438055010000e+128,
  2.42270953836727340000e+130,
  2.10775729837952790000e+132,
  1.85482642257398440000e+134,
  1.65079551609084600000e+136,
  1.48571596448176150000e+138,
  1.35200152767840290000e+140,
  1.24384140546413080000e+142,
  1.15677250708164160000e+144,
  1.08736615665674310000e+146,
  1.03299784882390590000e+148,
  9.91677934870949650000e+149,
  9.61927596824821200000e+151,
  9.42689044888324800000e+153,
  9.33262154439441530000e+155
};

double tab_oddfac[100] = {
  1.00000000000000000000e+00,
  3.00000000000000000000e+00,
  1.50000000000000000000e+01,
  1.05000000000000000000e+02,
  9.45000000000000000000e+02,
  1.03950000000000000000e+04,
  1.35135000000000000000e+05,
  2.02702500000000000000e+06,
  3.44594250000000000000e+07,
  6.54729075000000000000e+08,
  1.37493105750000000000e+10,
  3.16234143225000000000e+11,
  7.90585358062500000000e+12,
  2.13458046676875000000e+14,
  6.19028335362937500000e+15,
  1.91898783962510620000e+17,
  6.33265987076285030000e+18,
  2.21643095476699760000e+20,
  8.20079453263789190000e+21,
  3.19830986772877750000e+23,
  1.31130704576879880000e+25,
  5.63862029680583510000e+26,
  2.53737913356262560000e+28,
  1.19256819277443420000e+30,
  5.84358414459472710000e+31,
  2.98022791374331070000e+33,
  1.57952079428395470000e+35,
  8.68736436856175120000e+36,
  4.95179769008019790000e+38,
  2.92156063714731710000e+40,
  1.78215198865986340000e+42,
  1.12275575285571380000e+44,
  7.29791239356214030000e+45,
  4.88960130368663390000e+47,
  3.37382489954377750000e+49,
  2.39541567867608200000e+51,
  1.74865344543353980000e+53,
  1.31149008407515480000e+55,
  1.00984736473786930000e+57,
  7.97779418142916720000e+58,
  6.46201328695762540000e+60,
  5.36347102817482920000e+62,
  4.55895037394860490000e+64,
  3.96628682533528650000e+66,
  3.52999527454840480000e+68,
  3.21229569983904810000e+70,
  2.98743500085031500000e+72,
  2.83806325080779900000e+74,
  2.75292135328356520000e+76,
  2.72539213975072950000e+78,
  2.75264606114823660000e+80,
  2.83522544298268390000e+82,
  2.97698671513181800000e+84,
  3.18537578519104520000e+86,
  3.47205960585823940000e+88,
  3.85398616250264570000e+90,
  4.35500436362798950000e+92,
  5.00825501817218820000e+94,
  5.85965837126145990000e+96,
  6.97299346180113710000e+98,
  8.43732208877937610000e+100,
  1.03779061691986340000e+103,
  1.29723827114982910000e+105,
  1.64749260436028310000e+107,
  2.12526545962476530000e+109,
  2.78409775210844210000e+111,
  3.70285001030422840000e+113,
  4.99884751391070810000e+115,
  6.84842109405767050000e+117,
  9.51930532074016210000e+119,
  1.34222205022436280000e+122,
  1.91937753182083880000e+124,
  2.78309742114021610000e+126,
  4.09115320907611790000e+128,
  6.09581828152341530000e+130,
  9.20468560510035710000e+132,
  1.40831689758035470000e+135,
  2.18289119124954970000e+137,
  3.42713917026179330000e+139,
  5.44915128071625130000e+141,
  8.77313356195316350000e+143,
  1.43002077059836580000e+146,
  2.35953427148730350000e+148,
  3.94042223338379690000e+150,
  6.65931357441861660000e+152,
  1.13874262122558340000e+155,
  1.97002473472025930000e+157,
  3.44754328576045370000e+159,
  6.10215161579600390000e+161,
  1.09228513922748460000e+164,
  1.97703610200174720000e+166,
  3.61797606666319710000e+168,
  6.69325572332691500000e+170,
  1.25163882026213320000e+173,
  2.36559737029543140000e+175,
  4.51829097726427380000e+177,
  8.72030158612004980000e+179,
  1.70045880929340960000e+182,
  3.34990385430801700000e+184,
  6.66630867007295330000e+186
};


static double f1c(int n) {
    double x;
    if(n < MAX_FACTAB) return tab_fac[n];
    else {
	x = (double)n;
	while(--n >= MAX_FACTAB) x *= (double)n;
	return x*tab_fac[n];
    }
}


static double f2c(int n) {
    double x;
    int m;
    m = n/2;
    if(n < MAX_FACTAB) {
	if(n%2 == 0)
	    return ldexp(f1c(m), m);
	else
	    return tab_oddfac[m];
    } else {
	x = (double)n;
	n -= 2;
	while(n >= MAX_FACTAB) {
	    x *= (double)n;
	    n -= 2;
	}
	return x*f2c(n);
    }
}


static double f1h(int n) {
    double x;
    if(n%2==1) {
	n /= 2;
	if(n < MAX_FACTAB)
	    return ldexp(tab_oddfac[n], -n-1)*c_pi_sqrt;
	else
	    return ldexp(f2c(2*n+1), -n-1)*c_pi_sqrt;
    } else {
	n /= 2;
	if(n < MAX_FACTAB) return tab_fac[n];
	else {
	    x = (double)n;
	    while(--n >= MAX_FACTAB) x *= (double)n;
	    return x*tab_fac[n];
	}
    }
}


double clebsch(int jj1, int jj2, int jj3, int mm1, int mm2, int mm3) {
    int nnu, lower, upper;
    double x, sign;

    if(mm3 != mm1 + mm2) return 0.;

    x = 0.0;
    lower = jj2-jj3-mm1;
    lower = (jj1-jj3+mm2 > lower? jj1-jj3+mm2 : lower);
    if(lower < 0) lower = 0;
    sign = lower%4? -1. : 1.;
    upper = jj1+jj2-jj3;
    upper = (jj1-mm1 < upper? jj1-mm1 : upper);
    upper = (jj2+mm2 < upper? jj2+mm2 : upper);
    assert(!(lower%2));
    assert(!(upper%2));
    for(nnu = lower; nnu <= upper; nnu += 2) {
	x += sign/(f1h(nnu)*f1h(jj1+jj2-jj3-nnu)*f1h(jj1-mm1-nnu)
		   *f1h(jj2+mm2-nnu)*f1h(jj3-jj2+mm1+nnu)
		   *f1h(jj3-jj1-mm2+nnu));

	sign = -sign;
    }

    x *= sqrt((double)(jj3+1)*f1h(jj1+jj2-jj3)*f1h(jj3+jj1-jj2)
	      *f1h(jj3+jj2-jj1)/f1h(jj1+jj2+jj3+2)
	      *f1h(jj1+mm1)*f1h(jj1-mm1)*f1h(jj2+mm2)*f1h(jj2-mm2)
	      *f1h(jj3+mm3)*f1h(jj3-mm3));
    return x;
}

